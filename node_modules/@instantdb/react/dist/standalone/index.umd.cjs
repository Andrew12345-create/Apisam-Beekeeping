(function(D,C){typeof exports=="object"&&typeof module<"u"?C(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],C):(D=typeof globalThis<"u"?globalThis:D||self,C(D.instantReact={},D.React))})(this,function(D,C){"use strict";function V(t){if(typeof t=="number")return(Math.abs(t*2654435761)>>>0).toString(16);if(typeof t=="boolean")return t?"1":"0";if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string"){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24),e=e>>>0;return e.toString(16)}if(Array.isArray(t)){let e=2166136261;for(let n=0;n<t.length;n++){e^=(n+1)*2654435761;const r=V(t[n]);for(let i=0;i<r.length;i++)e^=r.charCodeAt(i),e*=16777619,e=e>>>0}return e.toString(16)}if(typeof t=="object"){let e=2166136261;const n=Object.keys(t).sort();for(let r=0;r<n.length;r++){const i=n[r],s=V(i);e^=parseInt(s,16),e*=16777619,e=e>>>0;const o=V(t[i]);e^=parseInt(o,16),e*=16777619,e=e>>>0}return e.toString(16)}return V(String(t))}const L={Remove:"remove",Replace:"replace",Add:"add"},qn=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),Yi=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),ft=Symbol.iterator,re={mutable:"mutable",immutable:"immutable"},Lt={};function Ve(t,e){return t instanceof Map?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function Bn(t,e){if(e in t){let n=Reflect.getPrototypeOf(t);for(;n;){const r=Reflect.getOwnPropertyDescriptor(n,e);if(r)return r;n=Reflect.getPrototypeOf(n)}}}function Ft(t){return Object.getPrototypeOf(t)===Set.prototype}function Nt(t){return Object.getPrototypeOf(t)===Map.prototype}function ie(t){var e;return(e=t.copy)!==null&&e!==void 0?e:t.original}function me(t){return!!k(t)}function k(t){return typeof t!="object"?null:t==null?void 0:t[qn]}function Kt(t){var e;const n=k(t);return n?(e=n.copy)!==null&&e!==void 0?e:n.original:t}function ae(t,e){if(!t||typeof t!="object")return!1;let n;return Object.getPrototypeOf(t)===Object.prototype||Array.isArray(t)||t instanceof Map||t instanceof Set||!!(e!=null&&e.mark)&&((n=e.mark(t,re))===re.immutable||typeof n=="function")}function Gn(t,e=[]){if(Object.hasOwnProperty.call(t,"key")){const n=t.parent.copy,r=k(pe(n,t.key));if(r!==null&&(r==null?void 0:r.original)!==t.original)return null;const i=t.parent.type===3,s=i?Array.from(t.parent.setMap.keys()).indexOf(t.key):t.key;if(!(i&&n.size>s||Ve(n,s)))return null;e.push(s)}if(t.parent)return Gn(t.parent,e);e.reverse();try{Ji(t.copy,e)}catch{return null}return e}function ve(t){return Array.isArray(t)?1:t instanceof Map?2:t instanceof Set?3:0}function pe(t,e){return ve(t)===2?t.get(e):t[e]}function qe(t,e,n){ve(t)===2?t.set(e,n):t[e]=n}function Wt(t,e){const n=k(t);return(n?ie(n):t)[e]}function ye(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function zt(t){if(t)for(;t.finalities.revoke.length>0;)t.finalities.revoke.pop()()}function Se(t,e){return e?t:[""].concat(t).map(n=>{const r=`${n}`;return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}function Ji(t,e){for(let n=0;n<e.length-1;n+=1){const r=e[n];if(t=pe(ve(t)===3?Array.from(t):t,r),typeof t!="object")throw new Error(`Cannot resolve patch at '${e.join("/")}'.`)}return t}function Zi(t){const e=Object.create(Object.getPrototypeOf(t));return Reflect.ownKeys(t).forEach(n=>{let r=Reflect.getOwnPropertyDescriptor(t,n);if(r.enumerable&&r.configurable&&r.writable){e[n]=t[n];return}r.writable||(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(r={configurable:!0,writable:!0,enumerable:r.enumerable,value:t[n]}),Reflect.defineProperty(e,n,r)}),e}const Xi=Object.prototype.propertyIsEnumerable;function Qn(t,e){let n;if(Array.isArray(t))return Array.prototype.concat.call(t);if(t instanceof Set){if(!Ft(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t.values())}return Set.prototype.difference?Set.prototype.difference.call(t,new Set):new Set(t.values())}else if(t instanceof Map){if(!Nt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t)}return new Map(t)}else if(e!=null&&e.mark&&(n=e.mark(t,re),n!==void 0)&&n!==re.mutable){if(n===re.immutable)return Zi(t);if(typeof n=="function"){if(e.enablePatches||e.enableAutoFreeze)throw new Error("You can't use mark and patches or auto freeze together.");return n()}throw new Error(`Unsupported mark result: ${n}`)}else if(typeof t=="object"&&Object.getPrototypeOf(t)===Object.prototype){const r={};return Object.keys(t).forEach(i=>{r[i]=t[i]}),Object.getOwnPropertySymbols(t).forEach(i=>{Xi.call(t,i)&&(r[i]=t[i])}),r}else throw new Error("Please check mark() to ensure that it is a stable marker draftable function.")}function Q(t){t.copy||(t.copy=Qn(t.original,t.options))}function Be(t){if(!ae(t))return Kt(t);if(Array.isArray(t))return t.map(Be);if(t instanceof Map){const n=Array.from(t.entries()).map(([r,i])=>[r,Be(i)]);if(!Nt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Map(n)}if(t instanceof Set){const n=Array.from(t).map(Be);if(!Ft(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Set(n)}const e=Object.create(Object.getPrototypeOf(t));for(const n in t)e[n]=Be(t[n]);return e}function lt(t){return me(t)?Be(t):t}function fe(t){var e;t.assignedMap=(e=t.assignedMap)!==null&&e!==void 0?e:new Map,t.operated||(t.operated=!0,t.parent&&fe(t.parent))}function Hn(){throw new Error("Cannot modify frozen object")}function Ce(t,e,n,r,i){{n=n??new WeakMap,r=r??[],i=i??[];const o=n.has(t)?n.get(t):t;if(r.length>0){const a=r.indexOf(o);if(o&&typeof o=="object"&&a!==-1)throw r[0]===o?new Error("Forbids circular reference"):new Error(`Forbids circular reference: ~/${i.slice(0,a).map((u,c)=>{if(typeof u=="symbol")return`[${u.toString()}]`;const d=r[c];return typeof u=="object"&&(d instanceof Map||d instanceof Set)?Array.from(d.keys()).indexOf(u):u}).join("/")}`);r.push(o),i.push(e)}else r.push(o)}if(Object.isFrozen(t)||me(t)){r.pop(),i.pop();return}switch(ve(t)){case 2:for(const[a,u]of t)Ce(a,a,n,r,i),Ce(u,a,n,r,i);t.set=t.clear=t.delete=Hn;break;case 3:for(const a of t)Ce(a,a,n,r,i);t.add=t.clear=t.delete=Hn;break;case 1:Object.freeze(t);let o=0;for(const a of t)Ce(a,o,n,r,i),o+=1;break;default:Object.freeze(t),Object.keys(t).forEach(a=>{const u=t[a];Ce(u,a,n,r,i)})}r.pop(),i.pop()}function Vt(t,e){const n=ve(t);if(n===0)Reflect.ownKeys(t).forEach(r=>{e(r,t[r],t)});else if(n===1){let r=0;for(const i of t)e(r,i,t),r+=1}else t.forEach((r,i)=>e(i,r,t))}function Yn(t,e,n){if(me(t)||!ae(t,n)||e.has(t)||Object.isFrozen(t))return;const r=t instanceof Set,i=r?new Map:void 0;if(e.add(t),Vt(t,(s,o)=>{var a;if(me(o)){const u=k(o);Q(u);const c=!((a=u.assignedMap)===null||a===void 0)&&a.size||u.operated?u.copy:u.original;qe(r?i:t,s,c)}else Yn(o,e,n)}),i){const s=t,o=Array.from(s);s.clear(),o.forEach(a=>{s.add(i.has(a)?i.get(a):a)})}}function es(t,e){const n=t.type===3?t.setMap:t.copy;t.finalities.revoke.length>1&&t.assignedMap.get(e)&&n&&Yn(pe(n,e),t.finalities.handledSet,t.options)}function qt(t){t.type===3&&t.copy&&(t.copy.clear(),t.setMap.forEach(e=>{t.copy.add(Kt(e))}))}function Bt(t,e,n,r){if(t.operated&&t.assignedMap&&t.assignedMap.size>0&&!t.finalized){if(n&&r){const s=Gn(t);s&&e(t,s,n,r)}t.finalized=!0}}function Gt(t,e,n,r){const i=k(n);i&&(i.callbacks||(i.callbacks=[]),i.callbacks.push((s,o)=>{var a;const u=t.type===3?t.setMap:t.copy;if(ye(pe(u,e),n)){let c=i.original;i.copy&&(c=i.copy),qt(t),Bt(t,r,s,o),t.options.enableAutoFreeze&&(t.options.updatedValues=(a=t.options.updatedValues)!==null&&a!==void 0?a:new WeakMap,t.options.updatedValues.set(c,i.original)),qe(u,e,c)}}),t.options.enableAutoFreeze&&i.finalities!==t.finalities&&(t.options.enableAutoFreeze=!1)),ae(n,t.options)&&t.finalities.draft.push(()=>{const s=t.type===3?t.setMap:t.copy;ye(pe(s,e),n)&&es(t,e)})}function ts(t,e,n,r,i){let{original:s,assignedMap:o,options:a}=t,u=t.copy;u.length<s.length&&([s,u]=[u,s],[n,r]=[r,n]);for(let c=0;c<s.length;c+=1)if(o.get(c.toString())&&u[c]!==s[c]){const d=e.concat([c]),f=Se(d,i);n.push({op:L.Replace,path:f,value:lt(u[c])}),r.push({op:L.Replace,path:f,value:lt(s[c])})}for(let c=s.length;c<u.length;c+=1){const d=e.concat([c]),f=Se(d,i);n.push({op:L.Add,path:f,value:lt(u[c])})}if(s.length<u.length){const{arrayLengthAssignment:c=!0}=a.enablePatches;if(c){const d=e.concat(["length"]),f=Se(d,i);r.push({op:L.Replace,path:f,value:s.length})}else for(let d=u.length;s.length<d;d-=1){const f=e.concat([d-1]),l=Se(f,i);r.push({op:L.Remove,path:l})}}}function ns({original:t,copy:e,assignedMap:n},r,i,s,o){n.forEach((a,u)=>{const c=pe(t,u),d=lt(pe(e,u)),f=a?Ve(t,u)?L.Replace:L.Add:L.Remove;if(ye(c,d)&&f===L.Replace)return;const l=r.concat(u),p=Se(l,o);i.push(f===L.Remove?{op:f,path:p}:{op:f,path:p,value:d}),s.push(f===L.Add?{op:L.Remove,path:p}:f===L.Remove?{op:L.Add,path:p,value:c}:{op:L.Replace,path:p,value:c})})}function rs({original:t,copy:e},n,r,i,s){let o=0;t.forEach(a=>{if(!e.has(a)){const u=n.concat([o]),c=Se(u,s);r.push({op:L.Remove,path:c,value:a}),i.unshift({op:L.Add,path:c,value:a})}o+=1}),o=0,e.forEach(a=>{if(!t.has(a)){const u=n.concat([o]),c=Se(u,s);r.push({op:L.Add,path:c,value:a}),i.unshift({op:L.Remove,path:c,value:a})}o+=1})}function Ge(t,e,n,r){const{pathAsArray:i=!0}=t.options.enablePatches;switch(t.type){case 0:case 2:return ns(t,e,n,r,i);case 1:return ts(t,e,n,r,i);case 3:return rs(t,e,n,r,i)}}const ht=(t,e,n=!1)=>{if(typeof t=="object"&&t!==null&&(!ae(t,e)||n))throw new Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},Qt={get size(){return ie(k(this)).size},has(t){return ie(k(this)).has(t)},set(t,e){const n=k(this),r=ie(n);return(!r.has(t)||!ye(r.get(t),e))&&(Q(n),fe(n),n.assignedMap.set(t,!0),n.copy.set(t,e),Gt(n,t,e,Ge)),this},delete(t){if(!this.has(t))return!1;const e=k(this);return Q(e),fe(e),e.original.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.copy.delete(t),!0},clear(){const t=k(this);if(this.size){Q(t),fe(t),t.assignedMap=new Map;for(const[e]of t.original)t.assignedMap.set(e,!1);t.copy.clear()}},forEach(t,e){const n=k(this);ie(n).forEach((r,i)=>{t.call(e,this.get(i),i,this)})},get(t){var e,n;const r=k(this),i=ie(r).get(t),s=((n=(e=r.options).mark)===null||n===void 0?void 0:n.call(e,i,re))===re.mutable;if(r.options.strict&&ht(i,r.options,s),s||r.finalized||!ae(i,r.options)||i!==r.original.get(t))return i;const o=Lt.createDraft({original:i,parentDraft:r,key:t,finalities:r.finalities,options:r.options});return Q(r),r.copy.set(t,o),o},keys(){return ie(k(this)).keys()},values(){const t=this.keys();return{[ft]:()=>this.values(),next:()=>{const e=t.next();return e.done?e:{done:!1,value:this.get(e.value)}}}},entries(){const t=this.keys();return{[ft]:()=>this.entries(),next:()=>{const e=t.next();if(e.done)return e;const n=this.get(e.value);return{done:!1,value:[e.value,n]}}}},[ft](){return this.entries()}},is=Reflect.ownKeys(Qt),Jn=(t,e,{isValuesIterator:n})=>()=>{var r,i;const s=e.next();if(s.done)return s;const o=s.value;let a=t.setMap.get(o);const u=k(a),c=((i=(r=t.options).mark)===null||i===void 0?void 0:i.call(r,a,re))===re.mutable;if(t.options.strict&&ht(o,t.options,c),!c&&!u&&ae(o,t.options)&&!t.finalized&&t.original.has(o)){const d=Lt.createDraft({original:o,parentDraft:t,key:o,finalities:t.finalities,options:t.options});t.setMap.set(o,d),a=d}else u&&(a=u.proxy);return{done:!1,value:n?a:[a,a]}},pt={get size(){return k(this).setMap.size},has(t){const e=k(this);if(e.setMap.has(t))return!0;Q(e);const n=k(t);return!!(n&&e.setMap.has(n.original))},add(t){const e=k(this);return this.has(t)||(Q(e),fe(e),e.assignedMap.set(t,!0),e.setMap.set(t,t),Gt(e,t,t,Ge)),this},delete(t){if(!this.has(t))return!1;const e=k(this);Q(e),fe(e);const n=k(t);return n&&e.setMap.has(n.original)?(e.assignedMap.set(n.original,!1),e.setMap.delete(n.original)):(!n&&e.setMap.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.setMap.delete(t))},clear(){if(!this.size)return;const t=k(this);Q(t),fe(t);for(const e of t.original)t.assignedMap.set(e,!1);t.setMap.clear()},values(){const t=k(this);Q(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:Jn(t,e,{isValuesIterator:!0})}},entries(){const t=k(this);Q(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:Jn(t,e,{isValuesIterator:!1})}},keys(){return this.values()},[ft](){return this.values()},forEach(t,e){const n=this.values();let r=n.next();for(;!r.done;)t.call(e,r.value,r.value,this),r=n.next()}};Set.prototype.difference&&Object.assign(pt,{intersection(t){return Set.prototype.intersection.call(new Set(this.values()),t)},union(t){return Set.prototype.union.call(new Set(this.values()),t)},difference(t){return Set.prototype.difference.call(new Set(this.values()),t)},symmetricDifference(t){return Set.prototype.symmetricDifference.call(new Set(this.values()),t)},isSubsetOf(t){return Set.prototype.isSubsetOf.call(new Set(this.values()),t)},isSupersetOf(t){return Set.prototype.isSupersetOf.call(new Set(this.values()),t)},isDisjointFrom(t){return Set.prototype.isDisjointFrom.call(new Set(this.values()),t)}});const ss=Reflect.ownKeys(pt),Zn=new WeakSet,Xn={get(t,e,n){var r,i;const s=(r=t.copy)===null||r===void 0?void 0:r[e];if(s&&Zn.has(s))return s;if(e===qn)return t;let o;if(t.options.mark){const c=e==="size"&&(t.original instanceof Map||t.original instanceof Set)?Reflect.get(t.original,e):Reflect.get(t.original,e,n);if(o=t.options.mark(c,re),o===re.mutable)return t.options.strict&&ht(c,t.options,!0),c}const a=ie(t);if(a instanceof Map&&is.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(Qt,"size").get.call(t.proxy);const c=Qt[e];if(c)return c.bind(t.proxy)}if(a instanceof Set&&ss.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(pt,"size").get.call(t.proxy);const c=pt[e];if(c)return c.bind(t.proxy)}if(!Ve(a,e)){const c=Bn(a,e);return c?"value"in c?c.value:(i=c.get)===null||i===void 0?void 0:i.call(t.proxy):void 0}const u=a[e];if(t.options.strict&&ht(u,t.options),t.finalized||!ae(u,t.options))return u;if(u===Wt(t.original,e)){if(Q(t),t.copy[e]=Ht({original:t.original[e],parentDraft:t,key:t.type===1?Number(e):e,finalities:t.finalities,options:t.options}),typeof o=="function"){const c=k(t.copy[e]);return Q(c),fe(c),c.copy}return t.copy[e]}return u},set(t,e,n){var r;if(t.type===3||t.type===2)throw new Error("Map/Set draft does not support any property assignment.");let i;if(t.type===1&&e!=="length"&&!(Number.isInteger(i=Number(e))&&i>=0&&(e===0||i===0||String(i)===String(e))))throw new Error("Only supports setting array indices and the 'length' property.");const s=Bn(ie(t),e);if(s!=null&&s.set)return s.set.call(t.proxy,n),!0;const o=Wt(ie(t),e),a=k(o);return a&&ye(a.original,n)?(t.copy[e]=n,t.assignedMap=(r=t.assignedMap)!==null&&r!==void 0?r:new Map,t.assignedMap.set(e,!1),!0):(ye(n,o)&&(n!==void 0||Ve(t.original,e))||(Q(t),fe(t),Ve(t.original,e)&&ye(n,t.original[e])?t.assignedMap.delete(e):t.assignedMap.set(e,!0),t.copy[e]=n,Gt(t,e,n,Ge)),!0)},has(t,e){return e in ie(t)},ownKeys(t){return Reflect.ownKeys(ie(t))},getOwnPropertyDescriptor(t,e){const n=ie(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.type!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},getPrototypeOf(t){return Reflect.getPrototypeOf(t.original)},setPrototypeOf(){throw new Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw new Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(t,e){var n;return t.type===1?Xn.set.call(this,t,e,void 0,t.proxy):(Wt(t.original,e)!==void 0||e in t.original?(Q(t),fe(t),t.assignedMap.set(e,!1)):(t.assignedMap=(n=t.assignedMap)!==null&&n!==void 0?n:new Map,t.assignedMap.delete(e)),t.copy&&delete t.copy[e],!0)}};function Ht(t){const{original:e,parentDraft:n,key:r,finalities:i,options:s}=t,o=ve(e),a={type:o,finalized:!1,parent:n,original:e,copy:null,proxy:null,finalities:i,options:s,setMap:o===3?new Map(e.entries()):void 0};(r||"key"in t)&&(a.key=r);const{proxy:u,revoke:c}=Proxy.revocable(o===1?Object.assign([],a):a,Xn);if(i.revoke.push(c),Zn.add(u),a.proxy=u,n){const d=n;d.finalities.draft.push((f,l)=>{var p,y;const b=k(u);let _=d.type===3?d.setMap:d.copy;const w=pe(_,r),g=k(w);if(g){let m=g.original;g.operated&&(m=Kt(w)),qt(g),Bt(g,Ge,f,l),d.options.enableAutoFreeze&&(d.options.updatedValues=(p=d.options.updatedValues)!==null&&p!==void 0?p:new WeakMap,d.options.updatedValues.set(m,g.original)),qe(_,r,m)}(y=b.callbacks)===null||y===void 0||y.forEach(m=>{m(f,l)})})}else{const d=k(u);d.finalities.draft.push((f,l)=>{qt(d),Bt(d,Ge,f,l)})}return u}Lt.createDraft=Ht;function os(t,e,n,r,i){var s;const o=k(t),a=(s=o==null?void 0:o.original)!==null&&s!==void 0?s:t,u=!!e.length;if(o!=null&&o.operated)for(;o.finalities.draft.length>0;)o.finalities.draft.pop()(n,r);const c=u?e[0]:o?o.operated?o.copy:o.original:t;return o&&zt(o),i&&Ce(c,c,o==null?void 0:o.options.updatedValues),[c,n&&u?[{op:L.Replace,path:[],value:e[0]}]:n,r&&u?[{op:L.Replace,path:[],value:a}]:r]}function as(t,e){var n;const r={draft:[],revoke:[],handledSet:new WeakSet};let i,s;e.enablePatches&&(i=[],s=[]);const a=((n=e.mark)===null||n===void 0?void 0:n.call(e,t,re))===re.mutable||!ae(t,e)?t:Ht({original:t,parentDraft:null,finalities:r,options:e});return[a,(u=[])=>{const[c,d,f]=os(a,u,i,s,e.enableAutoFreeze);return e.enablePatches?[c,d,f]:c}]}function Yt(t){const{rootDraft:e,value:n,useRawReturn:r=!1,isRoot:i=!0}=t;Vt(n,(s,o,a)=>{const u=k(o);if(u&&e&&u.finalities===e.finalities){t.isContainDraft=!0;const c=u.original;if(a instanceof Set){const d=Array.from(a);a.clear(),d.forEach(f=>a.add(s===f?c:f))}else qe(a,s,c)}else typeof o=="object"&&o!==null&&(t.value=o,t.isRoot=!1,Yt(t))}),i&&(t.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),r&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function er(t){var e;const n=k(t);if(!ae(t,n==null?void 0:n.options))return t;const r=ve(t);if(n&&!n.operated)return n.original;let i;function s(){i=r===2?Nt(t)?new Map(t):new(Object.getPrototypeOf(t)).constructor(t):r===3?Array.from(n.setMap.values()):Qn(t,n==null?void 0:n.options)}if(n){n.finalized=!0;try{s()}finally{n.finalized=!1}}else i=t;if(Vt(i,(o,a)=>{if(n&&ye(pe(n.original,o),a))return;const u=er(a);u!==a&&(i===t&&s(),qe(i,o,u))}),r===3){const o=(e=n==null?void 0:n.original)!==null&&e!==void 0?e:i;return Ft(o)?new Set(i):new(Object.getPrototypeOf(o)).constructor(i)}return i}function tr(t){if(!me(t))throw new Error(`current() is only used for Draft, parameter: ${t}`);return er(t)}const yt=(t=>function e(n,r,i){var s,o,a;if(typeof n=="function"&&typeof r!="function")return function(S,...M){return e(S,U=>n.call(this,U,...M),r)};const u=n,c=r;let d=i;if(typeof r!="function"&&(d=r),d!==void 0&&Object.prototype.toString.call(d)!=="[object Object]")throw new Error(`Invalid options: ${d}, 'options' should be an object.`);d=Object.assign(Object.assign({},t),d);const f=me(u)?tr(u):u,l=Array.isArray(d.mark)?(S,M)=>{for(const U of d.mark){if(typeof U!="function")throw new Error(`Invalid mark: ${U}, 'mark' should be a function.`);const Y=U(S,M);if(Y)return Y}}:d.mark,p=(s=d.enablePatches)!==null&&s!==void 0?s:!1,y=(o=d.strict)!==null&&o!==void 0?o:!1,_={enableAutoFreeze:(a=d.enableAutoFreeze)!==null&&a!==void 0?a:!1,mark:l,strict:y,enablePatches:p};if(!ae(f,_)&&typeof f=="object"&&f!==null)throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");const[w,g]=as(f,_);if(typeof r!="function"){if(!ae(f,_))throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[w,g]}let m;try{m=c(w)}catch(S){throw zt(k(w)),S}const E=S=>{const M=k(w);if(!me(S)){if(S!==void 0&&!ye(S,w)&&(M!=null&&M.operated))throw new Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");const Y=S==null?void 0:S[Yi];if(Y){const ut=Y[0];return _.strict&&typeof S=="object"&&S!==null&&Yt({rootDraft:M,value:S,useRawReturn:!0}),g([ut])}if(S!==void 0)return typeof S=="object"&&S!==null&&Yt({rootDraft:M,value:S}),g([S])}if(S===w||S===void 0)return g([]);const U=k(S);if(_===U.options){if(U.operated)throw new Error("Cannot return a modified child draft.");return g([tr(S)])}return g([S])};return m instanceof Promise?m.then(E,S=>{throw zt(k(w)),S}):E(m)})();Object.prototype.constructor.toString();function nr(t,e){const n=Object.keys(t),r=Object.keys(e);return n.length===r.length&&Object.keys(t).every(i=>e.hasOwnProperty(i))}function rr(t,e){return Object.keys(t).length===Object.keys(e).length&&Object.keys(t).every(n=>e.hasOwnProperty(n)&&t[n]===e[n])}function bt(t,e){return typeof t!="object"||typeof e!="object"||t===null||e===null?t===e:nr(t,e)?Object.keys(t).every(n=>bt(t[n],e[n])):!1}function Jt(t){if(!Qe(t))return t;const e={};for(const[n,r]of Object.entries(t))r!==void 0&&(e[n]=r);return e}function ir(t,e){if(!Qe(t)||!Qe(e))return e;const n=Object.assign({},t);for(const r of Object.keys(e)){if(e[r]===void 0)continue;if(e[r]===null){delete n[r];continue}const i=Qe(t[r])&&Qe(e[r]);n[r]=i?ir(t[r],e[r]):e[r]}return n}function Qe(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function us(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let s=0;s<e.length-1;s++){const o=e[s];(!(o in r)||typeof r[o]!="object")&&(r[o]=typeof e[s+1]=="number"?[]:{}),r=r[o]}const i=e[e.length-1];Array.isArray(r)&&typeof i=="number"?r.splice(i,0,n):r[i]=n}function sr(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let i=0;i<e.length-1;i++){const s=e[i];(!(s in r)||typeof r[s]!="object")&&(r[s]=typeof e[i+1]=="number"?[]:{}),r=r[s]}r[e[e.length-1]]=n}function or(t,e){if(!t||e.length===0)return;const[n,...r]=e;if(n in t){if(r.length===0){Array.isArray(t)?t.splice(n,1):delete t[n];return}or(t[n],r),cs(t[n])&&delete t[n]}}function cs(t){return t&&Object.keys(t).length===0}const ar=/ZULU|YEKT|YEKST|YAPT|YAKT|YAKST|XJT|WGT|WGST|WFT|WETDST|WET|WDT|WAT|WAST|WAKT|WADT|VUT|VOLT|VLAT|VLAST|VET|UZT|UZST|UYT|UYST|UTC|UT|ULAT|ULAST|UCT|TVT|TRUT|TOT|TMT|TKT|TJT|TFT|TAHT|SGT|SCT|SAST|SADT|RET|PYT|PYST|PWT|PST|PONT|PMST|PMDT|PKT|PKST|PHT|PGT|PETT|PETST|PET|PDT|OMST|OMSST|NZT|NZST|NZDT|NUT|NST|NPT|NOVT|NOVST|NFT|NDT|MYT|MVT|MUT|MUST|MST|MSK|MSD|MPT|MMT|MHT|MEZ|METDST|MET|MESZ|MEST|MDT|MAWT|MART|MAGT|MAGST|LKT|LINT|LIGT|LHST|LHDT|KST|KRAT|KRAST|KOST|KGT|KGST|KDT|JST|JAYT|IST|IRT|IRKT|IRKST|IOT|IDT|ICT|HST|HKT|GYT|GMT|GILT|GFT|GET|GEST|GAMT|GALT|FNT|FNST|FKT|FKST|FJT|FJST|FET|EST|EGT|EGST|EETDST|EET|EEST|EDT|EAT|EAST|EASST|DDUT|DAVT|CXT|CST|COT|CLT|CLST|CKT|CHUT|CHAST|CHADT|CETDST|CET|CEST|CDT|CCT|CAST|CADT|BTT|BST|BRT|BRST|BRA|BOT|BORT|BNT|BDT|BDST|AZT|AZST|AZOT|AZOST|AWST|AWSST|AST|ART|ARST|ANAT|ANAST|AMT|AMST|ALMT|ALMST|AKST|AKDT|AFT|AEST|AESST|AEDT|ADT|ACWST|ACT|ACST|ACSST|ACDT$/,ds={ZULU:0,YEKT:18e3,YEKST:21600,YAPT:36e3,YAKT:32400,YAKST:32400,XJT:21600,WGT:-10800,WGST:-7200,WFT:43200,WETDST:3600,WET:0,WDT:32400,WAT:3600,WAST:25200,WAKT:43200,WADT:28800,VUT:39600,VOLT:10800,VLAT:36e3,VLAST:36e3,VET:-14400,UZT:18e3,UZST:21600,UYT:-10800,UYST:-7200,UTC:0,UT:0,ULAT:28800,ULAST:32400,UCT:0,TVT:43200,TRUT:36e3,TOT:46800,TMT:18e3,TKT:46800,TJT:18e3,TFT:18e3,TAHT:-36e3,SGT:28800,SCT:14400,SAST:7200,SADT:37800,RET:14400,PYT:-14400,PYST:-10800,PWT:32400,PST:-28800,PONT:39600,PMST:-10800,PMDT:-7200,PKT:18e3,PKST:21600,PHT:28800,PGT:36e3,PETT:43200,PETST:43200,PET:-18e3,PDT:-25200,OMST:21600,OMSST:21600,NZT:43200,NZST:43200,NZDT:46800,NUT:-39600,NST:-12600,NPT:20700,NOVT:25200,NOVST:25200,NFT:-12600,NDT:-9e3,MYT:28800,MVT:18e3,MUT:14400,MUST:18e3,MST:-25200,MSK:10800,MSD:14400,MPT:36e3,MMT:23400,MHT:43200,MEZ:3600,METDST:7200,MET:3600,MESZ:7200,MEST:7200,MDT:-21600,MAWT:18e3,MART:-34200,MAGT:39600,MAGST:39600,LKT:19800,LINT:50400,LIGT:36e3,LHST:37800,LHDT:37800,KST:32400,KRAT:25200,KRAST:25200,KOST:39600,KGT:21600,KGST:21600,KDT:36e3,JST:32400,JAYT:32400,IST:7200,IRT:12600,IRKT:28800,IRKST:28800,IOT:21600,IDT:10800,ICT:25200,HST:-36e3,HKT:28800,GYT:-14400,GMT:0,GILT:43200,GFT:-10800,GET:14400,GEST:14400,GAMT:-32400,GALT:-21600,FNT:-7200,FNST:-3600,FKT:-10800,FKST:-10800,FJT:43200,FJST:46800,FET:10800,EST:-18e3,EGT:-3600,EGST:0,EETDST:10800,EET:7200,EEST:10800,EDT:-14400,EAT:10800,EAST:-21600,EASST:-21600,DDUT:36e3,DAVT:25200,CXT:25200,CST:-21600,COT:-18e3,CLT:-14400,CLST:-10800,CKT:-36e3,CHUT:36e3,CHAST:45900,CHADT:49500,CETDST:7200,CET:3600,CEST:7200,CDT:-18e3,CCT:28800,CAST:34200,CADT:37800,BTT:21600,BST:3600,BRT:-10800,BRST:-7200,BRA:-10800,BOT:-14400,BORT:28800,BNT:28800,BDT:21600,BDST:7200,AZT:14400,AZST:14400,AZOT:-3600,AZOST:0,AWST:28800,AWSST:32400,AST:-14400,ART:-10800,ARST:-10800,ANAT:43200,ANAST:43200,AMT:-14400,AMST:14400,ALMT:21600,ALMST:25200,AKST:-32400,AKDT:-28800,AFT:16200,AEST:36e3,AESST:39600,AEDT:39600,ADT:-10800,ACWST:31500,ACT:-18e3,ACST:34200,ACSST:37800,ACDT:37800};function fs(t){return new Date(t)}function ls(t){return new Date(t+"Z")}const hs=/^(\d+)[\./-](\d+)[\./-](\d+)$/;function ps(t){const e=t.match(hs);if(!e)return null;const[n,r,i,s]=e;return r<=0||i<=0||s<=0?null:r>999?new Date(Date.UTC(r,i-1,s,0,0,0,0)):new Date(Date.UTC(s,r-1,i,0,0,0,0))}function ys(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function bs(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function _s(t){return new Date(t)}function gs(t){const e=/^(\w{3}) (\w{3}) (\d{2}) (\d{4})$/;if(!t.match(e))throw new Error(`Unable to parse \`${t}\` as a date.`);const r=new Date(t+" UTC");return new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0,0))}function Ts(t){const e=/^(.+T.+)([+-])(\d{2})$/,n=t.match(e);if(n){const[,r,i,s]=n,o=`${r}${i}${s}:00`;return new Date(o)}return null}function ws(t){const e=/^(\d+)-(\d{1,2})-(\d{1,2})([ T])(.+)$/,n=t.match(e);if(n){const[,r,i,s,o,a]=n,u=i.padStart(2,"0"),c=s.padStart(2,"0"),d=`${r}-${u}-${c}T${a}`;return new Date(d)}return null}function ms(t){const[e,n]=t.split(", "),[r,i,s]=e.split("/").map(Number),o=n.match(/(\d{1,2}):(\d{2}):(\d{2}) (AM|PM)/);if(!o)throw new Error(`Unable to parse time from: ${t}`);let[,a,u,c,d]=o;return a=Number(a),u=Number(u),c=Number(c),d==="PM"&&a!==12?a+=12:d==="AM"&&a===12&&(a=0),new Date(Date.UTC(s,r-1,i,a,u,c))}function vs(t){switch(t){case"epoch":return new Date(0);case"infinity":case"-infinity":case"today":case"tomorrow":case"yesterday":return null}}function Ss(t){const e=t.match(ar);if(!e)return null;const[n]=e,r=ds[n],i=new Date(t.replace(ar,"Z"));return new Date(i.getTime()-r*1e3)}const Os=[ps,bs,gs,ms,_s,ls,Ts,ys,fs,vs,Ss,ws];function Es(t,e){try{const n=t(e);return n instanceof Date&&!isNaN(n.getTime())?n:null}catch{return null}}function Zt(t){for(const e of Os){const n=Es(e,t);if(n)return n}return null}function As(t){try{const e=JSON.parse(t);return typeof e=="string"?Zt(e):null}catch{return null}}function _t(t){if(t!==void 0){if(t===null)return null;if(t instanceof Date)return t;if(typeof t=="string"){const e=Zt(t)||As(t)||Zt(t.trim());if(!e)throw new Error(`Unable to parse \`${t}\` as a date.`);return e}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date value \`${t}\`. Expected a date, number, or string, got type ${typeof t}.`)}}function ks(t){return t.cardinality==="one"}function Xt(t){return t["value-type"]==="ref"}function en(t){return t["value-type"]==="blob"}function Pe(t,e){return t[e]}function Ie(t,e){return e.reduce((n,r)=>n&&n.get(r),t)}function ue(t,e){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.delete(e[0]);return}const[n,...r]=e;t.has(n)&&ue(t.get(n),r)}function Z(t,e,n){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.set(e[0],n);return}const[r,...i]=e;let s=t.get(r);s||(s=new Map,t.set(r,s)),Z(s,i,n)}function ur(t,e,n){const r=new Map,i=new Map,s=new Map;for(const o of e){let[a,u,c,d]=o;const f=Pe(t,u);if(!f){console.warn("no such attr",a,t);continue}f["checked-data-type"]==="date"&&n&&(c=_t(c),o[2]=c),Xt(f)&&Z(s,[c,u,a],o),Z(r,[a,u,c],o),Z(i,[u,a,c],o)}return{eav:r,aev:i,vae:s}}function cr(t){const e=new Map,n=new Map,r=new Map,i=new Map;for(const s of Object.values(t)){const o=s["forward-identity"],[a,u,c]=o,d=s["reverse-identity"];if(Z(r,[u,c],s),en(s)&&Z(e,[u,c],s),s["primary?"]&&Z(n,[u],s),d){const[f,l,p]=d;Z(i,[l,p],s)}}return{blobAttrs:e,primaryKeys:n,forwardIdents:r,revIdents:i}}function dr(t){return{__type:t.__type,attrs:t.attrs,triples:X(t.eav,3),cardinalityInference:t.cardinalityInference,linkIndex:t.linkIndex,useDateObjects:t.useDateObjects}}function fr(t){return gt(t.attrs,t.triples,t.cardinalityInference,t.linkIndex,t.useDateObjects)}function js(t,e){return Ie(t.eav,[e])!==void 0}function tn(t){t.attrIndexes=cr(t.attrs)}function gt(t,e,n,r,i){const s=ur(t,e,i);return s.useDateObjects=i,s.attrs=t,s.attrIndexes=cr(t),s.cardinalityInference=n,s.linkIndex=r,s.__type="store",s}function He(t,e){var n,r;let i;if(Array.isArray(e[0])){const[o,a]=e[0],u=t.aev.get(o);if(!u)return null;i=(n=X(u,2).find(d=>d[2]===a))===null||n===void 0?void 0:n[0]}else i=e[0];if(!i)return null;const s=e[2];if(Array.isArray(s)&&s.length===2&&t.aev.get(s[0])){const[o,a]=s,u=t.aev.get(o);if(!u)return null;const d=(r=X(u,2).find(b=>b[2]===a))===null||r===void 0?void 0:r[0];if(!d)return null;const[f,l,p,...y]=e;return[i,l,d,...y]}else{const[o,...a]=e;return[i,...a]}}function lr(t,e){const n=He(t,e);if(!n)return;const[r,i,s]=n,o=Pe(t.attrs,i);o&&(ue(t.eav,[r,i,s]),ue(t.aev,[i,r,s]),Xt(o)&&ue(t.vae,[s,i,r]))}let Cs=0;function hr(t,e,n){const[r,i,s]=n;let o;const a=Ie(t.eav,[r,i,s]);return a&&(o=a[3]),o||Date.now()*10+Cs++}function pr(t,e){var n;const r=He(t,e);if(!r)return;let[i,s,o]=r;const a=Pe(t.attrs,s);if(!a)return;a["checked-data-type"]==="date"&&t.useDateObjects&&(o=_t(o));const u=Ie(t.eav,[i,s,o]),c=(n=u==null?void 0:u[3])!==null&&n!==void 0?n:hr(t,a,r),d=[i,s,o,c];ks(a)?(Z(t.eav,[i,s],new Map([[o,d]])),Z(t.aev,[s,i],new Map([[o,d]]))):(Z(t.eav,[i,s,o],d),Z(t.aev,[s,i,o],d)),Xt(a)&&Z(t.vae,[o,s,i],d)}function Ps(t,e){var n;const r=He(t,e);if(!r)return;const[i,s,o]=r,a=Pe(t.attrs,s);if(!a)return;if(!en(a))throw new Error("merge operation is not supported for links");const u=Ie(t.eav,[i,s]);if(!u)return;const c=(n=u.values().next())===null||n===void 0?void 0:n.value;if(!c)return;const d=c[2],f=ir(d,o),l=[i,s,f,hr(t,a,c)];Z(t.eav,[i,s],new Map([[f,l]]))}function nn(t,e){var n,r;const[i,s]=e,o=He(t,[i]);if(!o)return;const[a]=o,u=t.eav.get(a);if(u){for(const d of u.keys()){const f=t.attrs[d];f&&f["on-delete-reverse"]==="cascade"&&X(u.get(d),1).forEach(([l,p,y])=>{var b;return nn(t,[y,(b=f["reverse-identity"])===null||b===void 0?void 0:b[1]])}),(!s||!f||((n=f["forward-identity"])===null||n===void 0?void 0:n[1])===s)&&(ue(t.aev,[d,a]),ue(t.eav,[a,d]))}u.size===0&&ue(t.eav,[a])}const c=t.vae.get(a)&&X(t.vae.get(a),2);c&&c.forEach(d=>{var f,l,p;const[y,b,_]=d,w=t.attrs[b];(!s||!w||((f=w["reverse-identity"])===null||f===void 0?void 0:f[1])===s)&&(ue(t.eav,[y,b,_]),ue(t.aev,[b,y,_]),ue(t.vae,[_,b,y])),w&&w["on-delete"]==="cascade"&&((l=w["reverse-identity"])===null||l===void 0?void 0:l[1])===s&&nn(t,[y,(p=w["forward-identity"])===null||p===void 0?void 0:p[1]])}),((r=t.vae.get(a))===null||r===void 0?void 0:r.size)===0&&ue(t.vae,[a])}function yr(t,e){const n=ur(t.attrs,e,t.useDateObjects);Object.keys(n).forEach(r=>{t[r]=n[r]})}function Is(t,[e]){t.attrs[e.id]=e,tn(t)}function br(t){return X(t.eav,3)}function Ms(t,[e]){if(!t.attrs[e])return;const n=br(t).filter(([r,i])=>i!==e);delete t.attrs[e],tn(t),yr(t,n)}function Rs(t,[e]){const n=t.attrs[e.id];n&&(t.attrs[e.id]=Object.assign(Object.assign({},n),e),tn(t),yr(t,br(t)))}function xs(t,e){const[n,...r]=e;switch(n){case"add-triple":pr(t,r);break;case"deep-merge-triple":Ps(t,r);break;case"retract-triple":lr(t,r);break;case"delete-entity":nn(t,r);break;case"add-attr":Is(t,r);break;case"delete-attr":Ms(t,r);break;case"update-attr":Rs(t,r);break;case"restore-attr":break;case"rule-params":break;default:throw new Error(`unhandled transaction action: ${n}`)}}function X(t,e,n=[]){if(!t||e===0)return n;if(e===1){for(const r of t.values())n.push(r);return n}for(const r of t.values())X(r,e-1,n);return n}function Tt(t,e,n){var r;const i=[];if(n!=null&&n.hasOwnProperty("$not")){for(const o of e.keys())n.$not!==o&&i.push(e.get(o));return i}if(n!=null&&n.hasOwnProperty("$isNull")){const{attrId:o,isNull:a,reverse:u}=n.$isNull;if(u)for(const c of e.keys()){const d=t.vae.get(c),f=!d||!d.get(o);(a?f:!f)&&i.push(e.get(c))}else{const c=t.aev.get(o);for(const d of e.keys()){const f=!c||((r=c.get(d))===null||r===void 0?void 0:r.get(null))||!c.get(d);(a?f:!f)&&i.push(e.get(d))}}return i}if(n!=null&&n.$comparator)return X(e,1).filter(n.$op);const s=n.in||n.$in||[n];for(const o of s){const a=e.get(o);a&&i.push(a)}return i}function Ds(t,e,n){let r="";return t!==void 0&&(r+="e"),e!==void 0&&(r+="a"),n!==void 0&&(r+="v"),r}function $s(t,[e,n,r]){var i,s;switch(Ds(e,n,r)){case"e":{const a=t.eav.get(e);return X(a,2)}case"ea":{const a=(i=t.eav.get(e))===null||i===void 0?void 0:i.get(n);return X(a,1)}case"eav":{const a=(s=t.eav.get(e))===null||s===void 0?void 0:s.get(n);return a?Tt(t,a,r):[]}case"ev":{const a=t.eav.get(e);if(!a)return[];const u=[];for(const c of a.values())u.push(...Tt(t,c,r));return u}case"a":{const a=t.aev.get(n);return X(a,2)}case"av":{const a=t.aev.get(n);if(!a)return[];const u=[];for(const c of a.values())u.push(...Tt(t,c,r));return u}case"v":{const a=[];for(const u of t.eav.values())for(const c of u.values())a.push(...Tt(t,c,r));return a}default:return X(t.eav,3)}}function Us(t,e,n){var r;const i={};if(!e)return i;for(const[s,o]of e.entries()){const a=(r=t.eav.get(n))===null||r===void 0?void 0:r.get(o.id),u=X(a,1);for(const c of u)i[s]=c[2]}return i}function Te(t,e,n){var r;return(r=t.attrIndexes.forwardIdents.get(e))===null||r===void 0?void 0:r.get(n)}function _r(t,e,n){var r;return(r=t.attrIndexes.revIdents.get(e))===null||r===void 0?void 0:r.get(n)}function Ls(t,e){return t.attrIndexes.blobAttrs.get(e)}function gr(t,e){var n;const r=t.attrIndexes.primaryKeys.get(e);return r||((n=t.attrIndexes.forwardIdents.get(e))===null||n===void 0?void 0:n.get("id"))}function Fs(t,e){const n=He(t,e);if(!n)return;const[r,i,s]=n;if(Pe(t.attrs,i))return Ie(t.eav,[r,i])}function Ns(t,e){const n=e.filter(([r,i,s,o,a])=>{if(r!=="add-triple"&&r!=="deep-merge-triple")return!0;const u=a==null?void 0:a.mode;if(u!=="create"&&u!=="update")return!0;let c=!1;const d=Pe(t.attrs,s);if(d){const f=gr(t,d["forward-identity"][1]);c=!!Fs(t,[i,f==null?void 0:f.id,i])}return!(u==="create"&&c||u==="update"&&!c)});return yt(t,r=>{n.forEach(i=>{xs(r,i)})})}function Ks(t){return typeof t=="string"&&t.startsWith("?")}function Ws(t,e,n){if(n.hasOwnProperty(t)){const r=n[t];return wr(r,e,n)}return Object.assign(Object.assign({},n),{[t]:e})}function Tr(t,e,n){return t===e?n:null}function zs(t){switch(typeof t){case"string":return t.startsWith("?")?Ws:Tr;default:return Tr}}const Vs=["in","$in","$not","$isNull","$comparator"];function qs(t){for(const e of Vs)if(t.hasOwnProperty(e))return!0;return!1}function wr(t,e,n){return n?typeof t=="object"?qs(t)?n:null:zs(t)(t,e,n):null}function Bs(t,e,n){return t.reduce((r,i,s)=>{const o=e[s];return wr(i,o,r)},n)}function Gs(t,e,n){return Ys(t,e,n).map(r=>Bs(e,r,n)).filter(r=>r)}function Qs(t,e,n){return e.or?e.or.patterns.flatMap(r=>rn(t,r,n)):e.and?e.and.patterns.reduce((r,i)=>rn(t,i,r),n):n.flatMap(r=>Gs(t,e,r))}function rn(t,e,n=[{}]){return e.reduce((r,i)=>Qs(t,i,r),n)}function sn(t,e){return Array.isArray(e)?e.map(n=>sn(t,n)):Ks(e)?t[e]:e}function Hs(t,{find:e,where:n}){return rn(t,n).map(i=>sn(i,e))}function Ys(t,e,n){return $s(t,sn(n,e))}const Js=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Me(t){return typeof t=="string"&&Js.test(t)}const q=[];for(let t=0;t<256;++t)q.push((t+256).toString(16).slice(1));function Zs(t,e=0){return(q[t[e+0]]+q[t[e+1]]+q[t[e+2]]+q[t[e+3]]+"-"+q[t[e+4]]+q[t[e+5]]+"-"+q[t[e+6]]+q[t[e+7]]+"-"+q[t[e+8]]+q[t[e+9]]+"-"+q[t[e+10]]+q[t[e+11]]+q[t[e+12]]+q[t[e+13]]+q[t[e+14]]+q[t[e+15]]).toLowerCase()}let on;const Xs=new Uint8Array(16);function eo(){if(!on){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");on=crypto.getRandomValues.bind(crypto)}return on(Xs)}const mr={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function to(t,e,n){var i;if(mr.randomUUID&&!t)return mr.randomUUID();t=t||{};const r=t.random??((i=t.rng)==null?void 0:i.call(t))??eo();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Zs(r)}function vr(t){const e=t.replace(/-/g,""),n=[];for(let r=0;r<e.length;r+=2)n.push(parseInt(e.substring(r,r+2),16));return n}function no(t,e){for(let n=0;n<t.length;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return 0}function ro(t,e){return no(vr(t),vr(e))}function W(){return to()}function io(t,e){return t.localeCompare(e)}function so(){let t=io;if(typeof Intl=="object"&&Intl.hasOwnProperty("Collator"))try{t=Intl.Collator("en-US").compare}catch{}return t}const oo=so();let ao=0;function Ye(t){return wt(`_${t}`,ao++)}function wt(t,e){return`?${t}-${e}`}class Re extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function uo(t,e){const n=gr(t,e);if(!n)throw new Re(`Could not find id attr for ${e}`);return n}function Sr(t,e,n,r){return[co(t,e,n,r)]}function co(t,e,n,r){return[t(n,r),uo(e,n).id,t(n,r),t("time",r)]}function fo(t,e,n){return t.map(r=>r===e?n:r)}function Or(t,e,n,r,i){const s=Te(e,n,i),o=_r(e,n,i),a=s||o;if(!a)throw new Re(`Could not find attr for ${[n,i]}`);if(a["value-type"]!=="ref")throw new Error(`Attr ${a.id} is not a ref`);const[u,c]=a["forward-identity"],[d,f]=a["reverse-identity"],l=r+1,p=s?[t(c,r),a.id,t(f,l),Ye("time")]:[t(c,l),a.id,t(f,r),Ye("time")];return[s?f:c,l,p,a,!!s]}function Er(t,e){if(typeof e!="string")return function(o){return!1};const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,"."),i=new RegExp(`^${r}$`,t?void 0:"i");return function(o){return typeof o!="string"?!1:i.test(o)}}function lo(t,e){if(typeof e!="object"||e.hasOwnProperty("$in")||e.hasOwnProperty("in"))return e;const n=t["checked-data-type"]==="date";if(e.hasOwnProperty("$gt"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])>new Date(e.$gt)}:function(i){return i[2]>e.$gt}};if(e.hasOwnProperty("$gte"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])>=new Date(e.$gte)}:function(i){return i[2]>=e.$gte}};if(e.hasOwnProperty("$lt"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])<new Date(e.$lt)}:function(i){return i[2]<e.$lt}};if(e.hasOwnProperty("$lte"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])<=new Date(e.$lte)}:function(i){return i[2]<=e.$lte}};if(e.hasOwnProperty("$like")){const r=Er(!0,e.$like);return{$comparator:!0,$op:function(s){return r(s[2])}}}if(e.hasOwnProperty("$ilike")){const r=Er(!1,e.$ilike);return{$comparator:!0,$op:function(s){return r(s[2])}}}return e}function ho(t,e,n,r,i,s){const o=Te(e,n,i),a=_r(e,n,i),u=o||a;if(!u)throw new Re(`No attr for etype = ${n} label = ${i}`);if(s!=null&&s.hasOwnProperty("$isNull")){const c=Te(e,n,"id");if(!c)throw new Re(`No attr for etype = ${n} label = id`);return[t(n,r),c.id,{$isNull:{attrId:u.id,isNull:s.$isNull,reverse:!o}},Ye("time")]}return o?[t(n,r),u.id,lo(u,s),Ye("time")]:[s,u.id,t(n,r),Ye("time")]}function po(t,e,n,r,i){const[s,o,a]=i.reduce((u,c)=>{const[d,f,l]=u,[p,y,b]=Or(t,e,d,f,c);return[p,y,[...l,b]]},[n,r,[]]);return[s,o,a]}function an(t,e,n,r,i,s){const o=i.slice(0,i.length-1),a=i[i.length-1],[u,c,d]=po(t,e,n,r,o),f=ho(t,e,u,c,a,s);return d.concat([f])}function yo(t,e){return e?[e].concat(t):t}function bo([t,e]){return t==="or"&&Array.isArray(e)}function _o([t,e]){return t==="and"&&Array.isArray(e)}function go(t,e,n){return(r,i)=>{const s=t(r,i);return e==s?s:`${s}-${n}`}}function Ar(t,e,n,r,i,s){const o=t(r,i),a=s.map((u,c)=>{const d=go(t,o,c);return jr(d,n,r,i,u)});return{[e]:{patterns:a,joinSym:o}}}function To(t){const e=[];for(let n=1;n<=t.length;n++)e.push(t.slice(0,n));return e}function kr(t,e,n,r,i){return To(i).map(s=>an(t,e,n,r,s,{$isNull:!0}))}function jr(t,e,n,r,i){return Object.entries(i).flatMap(([s,o])=>{if(bo([s,o]))return Ar(t,"or",e,n,r,o);if(_o([s,o]))return Ar(t,"and",e,n,r,o);if(s==="$entityIdStartsWith")return[];const a=s.split(".");if(o!=null&&o.hasOwnProperty("$ne")&&(o=Object.assign(Object.assign({},o),{$not:o.$ne}),delete o.$ne),o!=null&&o.hasOwnProperty("$not")){const u=an(t,e,n,r,a,o),c=kr(t,e,n,r,a);return[{or:{patterns:[u,...c],joinSym:t(n,r)}}]}return o!=null&&o.hasOwnProperty("$isNull")&&o.$isNull===!0&&a.length>1?[{or:{patterns:kr(t,e,n,r,a),joinSym:t(n,r)}}]:an(t,e,n,r,a,o)})}function wo(t,e,n,r){const i=wt;return r?jr(i,t,e,n,r).concat(Sr(i,t,e,n)):Sr(i,t,e,n)}function mo(t,e,n){return[t(e,n),t("time",n)]}function vo(t,e,n,r,i,s){const[o,a,u,c,d]=Or(t,e,n,r,i),f=fo(u,t(n,r),s);return[o,a,f,c,d]}function So(t,e,{etype:n,level:r,form:i},s){const o=Object.keys(i).filter(a=>a!=="$");return o.length?Object.entries(s).map(function([u,c]){return o.map(function(l){var p,y,b;const _=!!(e.cardinalityInference&&(!((b=(y=(p=e.linkIndex)===null||p===void 0?void 0:p[n])===null||y===void 0?void 0:y[l])===null||b===void 0)&&b.isSingular));try{const[w,g,m]=vo(t,e,n,r,l,u),E=Pr(e,{etype:w,level:g,form:i[l],join:m}),S=_?E[0]:E;return{[l]:S}}catch(w){if(w instanceof Re)return{[l]:_?void 0:[]};throw w}}).reduce(function(l,p){return Object.assign(Object.assign({},l),p)},c)}):Object.values(s)}function Oo(t,e,n){return n==="string"?oo(t,e):t>e?1:-1}function Je(t,e,n,r,i){return e===r||e==null&&r==null?ro(t,n):r==null?1:e==null?-1:Oo(e,r,i)}function mt([t,e],[n,r],i){return Je(t,e,n,r,i)}function un(t){return t==null?t:new Date(t).getTime()}function Eo(t,e,n,r){var i;const[s,o,a,u]=t,c=n==="desc"?1:-1;if(((i=e["forward-identity"])===null||i===void 0?void 0:i[2])==="id")return mt(r,[s,u],null)===c;const[d,f]=r,l=e["checked-data-type"],p=l==="date"?un(f):f,y=l==="date"?un(a):a;return mt([d,p],[s,y],l)===c}function Ao(t,e){const n=e[1];return t.attrs[n]}function ko(t,e,n){const r=Object.keys(n)[0];return Te(t,e,r)}function jo(t,e,n,r){if(n)return Ao(t,n);if(r)return ko(t,e,r)}function Co(t,e,n){var r,i;if(!Array.isArray(n.fields))return Ls(t,e);const s=new Map;for(const o of n.fields){const a=Te(t,e,o),u=(r=a==null?void 0:a["forward-identity"])===null||r===void 0?void 0:r[2];u&&en(a)&&s.set(u,a)}if(!s.has("id")){const o=Te(t,e,"id"),a=(i=o==null?void 0:o["forward-identity"])===null||i===void 0?void 0:i[2];a&&s.set(a,o)}return s}function Po(t,{etype:e,pageInfo:n,dq:r,form:i}){var s,o;const a=(s=i==null?void 0:i.$)===null||s===void 0?void 0:s.order,u=Cr(i),c=Io(i);let d=Hs(t,r);const f=n==null?void 0:n["start-cursor"],l=jo(t,e,f,a);if(l&&((o=l==null?void 0:l["forward-identity"])===null||o===void 0?void 0:o[2])!=="id"){const b=l["checked-data-type"]==="date",_=l.id;d=d.map(([w])=>{var g,m,E,S,M;let U=(M=(S=(E=(m=(g=t.eav.get(w))===null||g===void 0?void 0:g.get(_))===null||m===void 0?void 0:m.values())===null||E===void 0?void 0:E.next())===null||S===void 0?void 0:S.value)===null||M===void 0?void 0:M[2];return b&&(U=un(U)),[w,U]})}d.sort(c==="asc"?function(_,w){return mt(_,w,l==null?void 0:l["checked-data-type"])}:function(_,w){return mt(w,_,l==null?void 0:l["checked-data-type"])});let p={};const y=Co(t,e,r);for(const b of d){const[_]=b;if(p[_]||!u&&f&&l&&Eo(f,l,c,b))continue;const w=Us(t,y,_);w&&(p[_]=w)}return p}function Io(t){var e;const n=(e=t.$)===null||e===void 0?void 0:e.order;return n&&n[Object.keys(n)[0]]||"asc"}function Cr(t){var e,n,r;const i=(e=t.$)===null||e===void 0?void 0:e.offset,s=(n=t.$)===null||n===void 0?void 0:n.before,o=(r=t.$)===null||r===void 0?void 0:r.after;return!i&&!s&&!o}function Mo(t,{etype:e,level:n,form:r,join:i,pageInfo:s}){var o,a,u,c,d;if(!Cr(r)&&(!s||!s["start-cursor"]))return[];const f=yo(wo(t,e,n,(o=r.$)===null||o===void 0?void 0:o.where),i),l=mo(wt,e,n),p=(a=r.$)===null||a===void 0?void 0:a.fields,y=Po(t,{etype:e,pageInfo:s,form:r,dq:{where:f,find:l,fields:p}}),b=((u=r.$)===null||u===void 0?void 0:u.limit)||((c=r.$)===null||c===void 0?void 0:c.first)||((d=r.$)===null||d===void 0?void 0:d.last);if(b!=null){n>0&&console.warn("WARNING: Limits in child queries are only run client-side. Data returned from the server will not have a limit.");const _=Object.entries(y);return _.length<=b?y:Object.fromEntries(_.slice(0,b))}return y}function Ro(t,e){try{return Mo(t,e)}catch(n){if(n instanceof Re)return{};throw n}}function Pr(t,e){const n=Ro(t,e);return So(wt,t,e,n)}function xo(t){const e={};for(const[n,r]of Object.entries(t))e[n]={startCursor:r["start-cursor"],endCursor:r["end-cursor"],hasNextPage:r["has-next-page?"],hasPreviousPage:r["has-previous-page?"]};return e}function Ir({store:t,pageInfo:e,aggregate:n},r){const s={data:Object.keys(r).reduce(function(a,u){return n!=null&&n[u]||u==="$$ruleParams"||(a[u]=Pr(t,{etype:u,form:r[u],level:0,pageInfo:e==null?void 0:e[u]})),a},{})};return e&&(s.pageInfo=xo(e)),n&&(s.aggregate=n),s}function Do(){const e={__etype:1,__ops:1,create:1,update:1,link:1,unlink:1,delete:1,merge:1,ruleParams:1};return new Set(Object.keys(e))}const $o=Do();function cn(t,e,n){const r={__etype:t,__ops:n};return new Proxy(r,{get:(i,s)=>{if(s==="__ops")return n;if(s==="__etype")return t;if($o.has(s))return(o,a)=>cn(t,e,[...n,a?[s,t,e,o,a]:[s,t,e,o]])}})}function Uo(t,e){return`lookup__${t}__${JSON.stringify(e)}`}function vt(t){return t.startsWith("lookup__")}function Mr(t){const[e,n,...r]=t.split("__");return[n,JSON.parse(r.join("__"))]}function Lo(t){return new Proxy({__etype:t},{get(e,n){if(n==="__etype")return t;const r=n;return vt(r)?cn(t,Mr(r),[]):cn(t,r,[])}})}function dn(){return new Proxy({},{get(t,e){return Lo(e)}})}const Fo=dn();function No(t){return t.__ops}function Ko(t,e){const{attrIdMap:n,refSwapAttrIds:r}=t,i=[];for(const o of e){const a=n[o];if(a)i.push(a);else if(Array.isArray(o)&&o.length==2&&n[o[0]]){const[u,c]=o;i.push([n[u],c])}else i.push(o)}const[s]=e;if((s==="add-triple"||s==="retract-triple")&&r.has(e[2])){const o=i[1];i[1]=i[3],i[3]=o}return i}function B(t,e,n){return Object.values(t).find(r=>{const[i,s,o]=r["forward-identity"];return s===e&&o===n})}function Oe(t,e,n){return Object.values(t).find(r=>{const i=r["reverse-identity"];if(!i)return!1;const[s,o,a]=i;return o===e&&a===n})}function Wo(t){if(Array.isArray(t))return t;const e=Object.entries(t);if(e.length!==1)throw new Error("lookup must be an object with a single unique attr and value.");return e[0]}function fn(t,e,n){return n.indexOf(".")!==-1&&!B(t,e,n)}function ln(t){const[e,n,...r]=t.split(".");if(r.length>0||n!=="id")throw new Error(`${t} is not a valid lookup attribute.`);return e}function zo(t,e,n){if(!fn(t,e,n))return B(t,e,n);const r=ln(n),i=B(t,e,r)||Oe(t,e,r);if(i&&i["value-type"]!=="ref")throw new Error(`${n} does not reference a valid link attribute.`);return i}function hn(t){return typeof t=="string"&&!vt(t)?null:typeof t=="string"&&vt(t)?Mr(t):Wo(t)}function ee(t,e,n){const r=hn(n);if(r===null)return n;const[i,s]=r,o=zo(t,e,i);if(!o||!o["unique?"])throw new Error(`${i} is not a unique attribute.`);return[o.id,s]}function Rr(t,e,n,r){const i=ee(t,e,n);return Array.isArray(i)?[["add-triple",i,B(t,e,"id").id,i]].concat(r):r}function Vo({attrs:t},[e,n,r]){const i=Object.entries(r).flatMap(([s,o])=>{const a=Array.isArray(o)?o:[o],u=B(t,e,s),c=Oe(t,e,s);return a.map(d=>u?["add-triple",ee(t,e,n),u.id,ee(t,u["reverse-identity"][1],d)]:["add-triple",ee(t,c["forward-identity"][1],d),c.id,ee(t,e,n)])});return Rr(t,e,n,i)}function qo({attrs:t},[e,n,r]){const i=Object.entries(r).flatMap(([s,o])=>{const a=Array.isArray(o)?o:[o],u=B(t,e,s),c=Oe(t,e,s);return a.map(d=>u?["retract-triple",ee(t,e,n),u.id,ee(t,u["reverse-identity"][1],d)]:["retract-triple",ee(t,c["forward-identity"][1],d),c.id,ee(t,e,n)])});return Rr(t,e,n,i)}function Bo(t,e,n){if(Array.isArray(n)){const[r,i]=n;for(const s of t||[]){const o=s==null?void 0:s.aev.get(r);if(o){for(const[a,u,c]of X(o,2))if(c===i)return!0}}}else for(const r of t||[]){const i=r==null?void 0:r.eav.get(n);if(i){for(const s of i.keys())if(r.attrs[s]["forward-identity"][1]==e)return!0}}return!1}function xr({stores:t,attrs:e},[n,r,i,s]){return(s==null?void 0:s.upsert)===!1?{mode:"update"}:(s==null?void 0:s.upsert)===!0?null:Bo(t,n,r)?{mode:"update"}:null}function Go(t,e){const{stores:n,attrs:r}=t,[i,s,o,a]=e,u=Jt(o),c=ee(r,i,s);return[["id",c]].concat(Object.entries(u)).map(([f,l])=>{const p=B(r,i,f);return p["checked-data-type"]==="date"&&t.useDateObjects&&(l=_t(l)),["add-triple",c,p.id,l,{mode:"create"}]})}function Qo(t,e){const{stores:n,attrs:r}=t,[i,s,o,a]=e,u=Jt(o),c=ee(r,i,s),d=xr(t,[i,c,o,a]);return[["id",c]].concat(Object.entries(u)).map(([l,p])=>{const y=B(r,i,l);return y["checked-data-type"]==="date"&&t.useDateObjects&&(p=_t(p)),["add-triple",c,y.id,p,...d?[d]:[]]})}function Ho({attrs:t},[e,n]){return[["delete-entity",ee(t,e,n),e]]}function Yo(t,e){const{stores:n,attrs:r}=t,[i,s,o,a]=e,u=Jt(o),c=ee(r,i,s),d=xr(t,[i,c,o,a]),f=Object.entries(u).map(([p,y])=>{const b=B(r,i,p);return["deep-merge-triple",c,b.id,y,...d?[d]:[]]});return[["add-triple",c,B(r,i,"id").id,c,...d?[d]:[]]].concat(f)}function Jo({attrs:t},[e,n,r]){return[["rule-params",ee(t,e,n),e,r]]}function Zo(t){const[e,n,r,i,s]=t;if(!i)return t;const o=Object.assign({},i);return delete o.id,[e,n,r,o,...s?[s]:[]]}function Xo(t,e){const[n,...r]=Zo(e);switch(n){case"merge":return Yo(t,r);case"create":return Go(t,r);case"update":return Qo(t,r);case"link":return Vo(t,r);case"unlink":return qo(t,r);case"delete":return Ho(t,r);case"ruleParams":return Jo(t,r);default:throw new Error(`unsupported action ${n}`)}}function ea(t){switch(t){case"string":case"date":case"boolean":case"number":return t;default:return}}function ta(t,e,n){var r,i;const s=(i=(r=t.entities[e])===null||r===void 0?void 0:r.attrs)===null||i===void 0?void 0:i[n];if(n==="id")return null;if(!s)throw new Error(`${e}.${n} does not exist in your schema`);const{unique:o,indexed:a}=s==null?void 0:s.config,u=ea(s==null?void 0:s.valueType);return{"index?":a,"unique?":o,"checked-data-type":u}}function St(t,e,n,r){const i=t?ta(t,e,n):null,s=W(),a=[W(),e,n];return Object.assign(Object.assign({id:s,"forward-identity":a,"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0},i||{}),r||{})}function na(t,e,n){return Object.values(t.links).find(i=>i.forward.on===e&&i.forward.label===n||i.reverse.on===e&&i.reverse.label===n)}function ra(t,e,n){const r=na(t,e,n);if(!r)throw new Error(`Couldn't find the link ${e}.${n} in your schema`);const{forward:i,reverse:s}=r;return{"forward-identity":[W(),i.on,i.label],"reverse-identity":[W(),s.on,s.label],cardinality:i.has==="one"?"one":"many","unique?":s.has==="one","on-delete":i.onDelete,"on-delete-reverse":s.onDelete}}function Dr(t,e,n,r){const i=t?ra(t,e,n):null,s=W(),o=[W(),e,n],a=[W(),n,e];return Object.assign(Object.assign({id:s,"forward-identity":o,"reverse-identity":a,"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0},i||{}),r||{})}const ia=new Set(["create","update","merge","link","unlink"]),sa=new Set(["link","unlink"]),oa=new Set(["create","update","merge"]),aa=new Set(["link","unlink","create","update","merge","delete","ruleParams"]),pn={"unique?":!0,"index?":!0},ua=Object.assign(Object.assign({},pn),{cardinality:"one"});function ca(t){const e=[],[n,r,i,s]=t;if(!aa.has(n))return e;const o=hn(i);if(o&&e.push({etype:r,lookupPair:o}),n==="link")for(const[a,u]of Object.entries(s)){const c=Array.isArray(u)?u:[u];for(const d of c){const f=hn(d);f&&e.push({etype:r,lookupPair:f,linkLabel:a})}}return e}function da({attrs:t,schema:e},n){var r,i;const[s,o,a]=[new Set,Object.assign({},t),[]];function u(f){o[f.id]=f,a.push(["add-attr",f]),s.add(f.id)}function c(f){f!=null&&f.isUnsynced&&!s.has(f.id)&&(a.push(["add-attr",f]),s.add(f.id))}function d(f,l){const p=B(o,f,l),y=Oe(o,f,l);c(p),c(y),!p&&!y&&u(Dr(e,f,l,ua))}for(const f of n)for(const{etype:l,lookupPair:p,linkLabel:y}of ca(f)){const b=p[0];if(y){d(l,y);const _=B(o,l,y),w=Oe(o,l,y);c(_),c(w);const g=((r=_==null?void 0:_["reverse-identity"])===null||r===void 0?void 0:r[1])||((i=w==null?void 0:w["forward-identity"])===null||i===void 0?void 0:i[1])||y;if(fn(o,g,b))d(g,ln(b));else{const m=B(o,g,b);m||u(St(e,g,b,pn)),c(m)}}else if(fn(o,l,b))d(l,ln(b));else{const _=B(o,l,b);_||u(St(e,l,b,pn)),c(_)}}for(const f of n){const[l,p,y,b]=f;if(ia.has(l)){const _=B(o,p,"id");c(_),_||u(St(e,p,"id",{"unique?":!0}));for(const w of Object.keys(b)){const g=B(o,p,w);if(c(g),oa.has(l)&&(g||u(St(e,p,w,w==="id"?{"unique?":!0}:null))),sa.has(l)){const m=Oe(o,p,w);!g&&!m&&u(Dr(e,p,w)),c(m)}}}}return[o,a]}function fa(t,e){const r=(Array.isArray(e)?e:[e]).flatMap(u=>No(u)),[i,s]=da(t,r),o=Object.assign(Object.assign({},t),{attrs:i}),a=r.flatMap(u=>Xo(o,u));return[...s,...a]}var le=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};function $r(t,e){typeof requestIdleCallback>"u"?t():requestIdleCallback(t,{timeout:e})}const Ze="__meta";class la{constructor(e,n){}}class yn{constructor(e){var n,r;this._subs=[],this._nextSave=null,this._nextGc=null,this._pendingSaveKeys=new Set,this._loadedKeys=new Set,this._version=0,this._meta={isLoading:!0,onLoadCbs:[],value:null,error:null,attempts:0},this._persister=e.persister,this._merge=e.merge,this.serialize=e.serialize,this.parse=e.parse,this._objectSize=e.objectSize,this._log=e.logger,this._saveThrottleMs=(n=e.saveThrottleMs)!==null&&n!==void 0?n:100,this._idleCallbackMaxWaitMs=(r=e.idleCallbackMaxWaitMs)!==null&&r!==void 0?r:1e3,this._gcOpts=e.gc,this.currentValue={},this._loadedKeys=new Set,this._loadingKeys={},this._initMeta(),e.preloadEntryCount&&this._preloadEntries(e.preloadEntryCount)}_initMeta(){return le(this,void 0,void 0,function*(){var e,n,r;this._meta.loadingPromise&&(yield this._meta.loadingPromise);try{const i=this._persister.getItem(Ze);this._meta.loadingPromise=i;const s=yield i;this._meta.isLoading=!1,this._meta.error=null,this._meta.loadingPromise=null,this._meta.attempts=0;const o=(n=(e=this._meta.value)===null||e===void 0?void 0:e.objects)!==null&&n!==void 0?n:{},a=s??{},u=(r=a.objects)!==null&&r!==void 0?r:{};this._meta.value=Object.assign(Object.assign({},a),{objects:Object.assign(Object.assign({},o),u)})}catch(i){this._meta.error=i,this._meta.attempts++,this._meta.loadingPromise=null}})}_getMeta(){return le(this,void 0,void 0,function*(){return this._meta.value?this._meta.value:this._meta.loadingPromise?(yield this._meta.loadingPromise,this._meta.value):(this._initMeta(),yield this._meta.loadingPromise,this._meta.value)})}_refreshMeta(){return le(this,void 0,void 0,function*(){return yield this._initMeta(),this._meta.value})}_preloadEntries(e){return le(this,void 0,void 0,function*(){const n=yield this.waitForMetaToLoad();if(!n)return;const r=Object.entries(n.objects);r.sort(([i,s],[o,a])=>a.updatedAt-s.updatedAt);for(const[i]of r.slice(0,e))this._loadKey(i)})}_getFromStorage(e){return le(this,void 0,void 0,function*(){try{const n=yield this._persister.getItem(e);return n&&this.parse(e,n)}catch(n){return console.error(`Unable to read from storage for key=${e}`,n),null}})}waitForKeyToLoad(e){return le(this,void 0,void 0,function*(){return this._loadedKeys.has(e)?this.currentValue[e]:(yield this._loadingKeys[e]||this._loadKey(e),this.currentValue[e])})}waitForMetaToLoad(){return le(this,void 0,void 0,function*(){return this._getMeta()})}unloadKey(e){this._loadedKeys.delete(e),delete this._loadingKeys[e],delete this.currentValue[e]}_loadKey(e){return le(this,void 0,void 0,function*(){if(this._loadedKeys.has(e)||e in this._loadingKeys)return;const n=this._getFromStorage(e);this._loadingKeys[e]=n;const r=yield n;if(delete this._loadingKeys[e],this._loadedKeys.add(e),r){const i=this._merge(e,r,this.currentValue[e]);i&&(this.currentValue[e]=i)}this.onKeyLoaded&&this.onKeyLoaded(e)})}_writeToStorage(e){var n,r;const i=[],s=e==null?void 0:e.skipGc;if(this._meta.isLoading){const p=new Promise((y,b)=>{var _;setTimeout(()=>this._enqueuePersist(e?Object.assign(Object.assign({},e),{attempts:(e.attempts||0)+1}):{attempts:1}).then(y).catch(b),10+((_=e==null?void 0:e.attempts)!==null&&_!==void 0?_:0)*1e3)});return i.push(p),Promise.all(i).then(y=>y.reduce((b,_)=>b+_,0))}const o=this._meta.value;if(!o)return Promise.resolve(0);const a=[],u=[];for(const p of this._pendingSaveKeys)p in this.currentValue?u.push(p):(a.push(p),delete o.objects[p]);for(const p of a){const y=this._persister.removeItem(p);i.push(y.then(()=>1)),this._loadedKeys.delete(p),this._pendingSaveKeys.delete(p)}const c=[],d=[[Ze,o]],f=(n=o.objects)!==null&&n!==void 0?n:{};o.objects=f;for(const p of u)if(this._loadedKeys.has(p)){const y=this.serialize(p,this.currentValue[p]);d.push([p,y]);const b=this._objectSize(y),_=(r=f[p])!==null&&r!==void 0?r:{createdAt:Date.now(),updatedAt:Date.now(),size:b};_.updatedAt=Date.now(),_.size=b,f[p]=_,this._pendingSaveKeys.delete(p)}else c.push(p);const l=this._persister.multiSet(d);i.push(l.then(()=>1));for(const p of c){const y=this._loadKey(p).then(()=>this._enqueuePersist(e));i.push(y)}return s||this.gc(),Promise.all(i).then(p=>p.reduce((y,b)=>y+b,0))}flush(){return le(this,void 0,void 0,function*(){return this._nextSave?(clearTimeout(this._nextSave),this._nextSave=null,this._writeToStorage()):void 0})}_gc(){return le(this,void 0,void 0,function*(){if(!this._gcOpts)return;const e=new Set(yield this._persister.getAllKeys());e.delete(Ze);const n=new Set(Object.keys(this.currentValue));for(const l of Object.keys(this._loadingKeys))n.add(l);for(const l of this._loadedKeys)n.add(l);const r=yield this._refreshMeta();if(!r){this._log.info("Could not gc because we were not able to load meta");return}const i=[],s={gcOpts:this._gcOpts,keys:e,sacredKeys:n,removed:[],metaRemoved:[],removedMissingCount:0,removedOldCount:0,removedThresholdCount:0,removedSizeCount:0};for(const l of e)n.has(l)||l in r.objects||(this._log.info("Lost track of key in meta",l),i.push(this._persister.removeItem(l)),s.removed.push(l),s.removedMissingCount++);const o=Date.now();for(const[l,p]of Object.entries(r.objects))!n.has(l)&&p.updatedAt<o-this._gcOpts.maxAgeMs&&(i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedOldCount++);const a=Object.entries(r.objects);a.sort(([l,p],[y,b])=>p.updatedAt-b.updatedAt);const u=a.filter(([l])=>!n.has(l));if(a.length>this._gcOpts.maxEntries)for(const[l]of u.slice(0,a.length-this._gcOpts.maxEntries))i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedThresholdCount++;const c=Object.entries(r.objects);c.sort(([l,p],[y,b])=>p.updatedAt-b.updatedAt);const d=c.filter(([l])=>!n.has(l));let f=c.reduce((l,[p,y])=>l+y.size,0);for(;f>0&&f>this._gcOpts.maxSize&&d.length;){const[[l,p]]=d.splice(0,1);f-=p.size,i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedSizeCount++}for(const l of Object.keys(r.objects))!e.has(l)&&!n.has(l)&&delete r.objects[l];return(s.removed.length||s.metaRemoved.length)&&i.push(this._enqueuePersist({skipGc:!0})),this._log.info("Completed GC",s),yield Promise.all(i),s})}gc(){this._nextGc||(this._nextGc=setTimeout(()=>{$r(()=>{this._nextGc=null,this._gc()},30*1e3)},1e3*60+Math.random()*500))}_enqueuePersist(e){return new Promise((n,r)=>{if(this._nextSave){n(0);return}this._nextSave=setTimeout(()=>{$r(()=>{this._nextSave=null,this._writeToStorage(e).then(n).catch(r)},this._idleCallbackMaxWaitMs)},this._saveThrottleMs)})}version(){return this._version}updateInPlace(e){this._version++;const[n,r]=yt(this.currentValue,e,{enablePatches:!0});for(const i of r){const s=i.path[0];s&&typeof s=="string"&&(this._pendingSaveKeys.add(s),this._loadedKeys.has(s)||this._loadKey(s))}this.currentValue=n,this._enqueuePersist();for(const i of this._subs)i(this.currentValue);return n}subscribe(e){return this._subs.push(e),e(this.currentValue),()=>{this._subs=this._subs.filter(n=>n!==e)}}}var be=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};const ha=6,pa=["kv","querySubs","syncSubs"];function ya(t){return function(n){console.error("Error in IndexedDB event",{source:t,event:n})}}function ba(t){return be(this,void 0,void 0,function*(){return new Promise(e=>{const n=indexedDB.open(t);n.onerror=r=>{e(null)},n.onsuccess=r=>{const s=r.target.result;e(s)},n.onupgradeneeded=r=>{var i;(i=r.target.transaction)===null||i===void 0||i.abort(),e(null)}})})}function _a(t,e,n){return be(this,void 0,void 0,function*(){const r=typeof e=="string"?JSON.parse(e):e;if(!r)return;const i=new Set;return new Promise((s,o)=>{var a,u,c,d;const f={};for(const[y,b]of Object.entries(r)){const _=typeof b=="string"?JSON.parse(b):b;if(_.lastAccessed){const g={createdAt:_.lastAccessed,updatedAt:_.lastAccessed,size:(d=(c=(u=(a=_.result)===null||a===void 0?void 0:a.store)===null||u===void 0?void 0:u.triples)===null||c===void 0?void 0:c.length)!==null&&d!==void 0?d:0};f[y]=g}const w=n.put(_,y);i.add(w)}const l={objects:f},p=n.put(l,Ze);i.add(p);for(const y of i)y.onsuccess=()=>{i.delete(y),i.size===0&&s()},y.onerror=b=>{o(b)}})})}function Ur(t,e,n){return be(this,void 0,void 0,function*(){const r=n.put(e,t);return new Promise((i,s)=>{r.onsuccess=()=>i(),r.onerror=o=>s(o)})})}function ga(t,e){return be(this,void 0,void 0,function*(){const n=yield ba(`instant_${t}_5`);if(!n)return;const r=yield new Promise((d,f)=>{const y=n.transaction(["kv"],"readonly").objectStore("kv").openCursor();y.onerror=_=>{f(_)};const b=[];y.onsuccess=()=>{const _=y.result;if(_){const w=_.key,g=_.value;b.push([w,g]),_.continue()}else d(b)},y.onerror=_=>{f(_)}}),i=e.transaction(["kv","querySubs"],"readwrite"),s=i.objectStore("kv"),o=i.objectStore("querySubs"),a=[],u={objects:{}};for(const[d,f]of r)switch(d){case"querySubs":{const l=_a(d,f,o);a.push(l);break}default:{const l=Ur(d,f,s);a.push(l);const p={createdAt:Date.now(),updatedAt:Date.now(),size:0};u.objects[d]=p;break}}const c=Ur(Ze,u,s);a.push(c),yield Promise.all(a),yield new Promise((d,f)=>{i.oncomplete=l=>d(l),i.onerror=l=>f(l),i.onabort=l=>f(l)})})}const Lr=new Map;class Fr extends la{constructor(e,n){super(e,n),this.dbName=`instant_${e}_${ha}`,this._storeName=n,this._appId=e,this._dbPromise=this._init()}_init(){return new Promise((e,n)=>{let r=!1;const i=indexedDB.open(this.dbName,1);i.onerror=s=>{n(s)},i.onsuccess=s=>{const a=s.target.result;if(r){const u=ga(this._appId,a).catch(c=>{ya("Error upgrading store from version 5 to 6.")(c)});Lr.set(this.dbName,u),u.then(()=>e(a)).catch(()=>e(a))}else{const u=Lr.get(this.dbName);u?u.then(()=>e(a)).catch(()=>e(a)):e(a)}},i.onupgradeneeded=s=>{r=!0,this._upgradeStore(s)}})}_upgradeStore(e){const r=e.target.result;for(const i of pa)r.objectStoreNames.contains(i)||r.createObjectStore(i)}getItem(e){return be(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const a=n.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);a.onerror=u=>{i(u)},a.onsuccess=u=>{a.result?r(a.result):r(null)}})})}setItem(e,n){return be(this,void 0,void 0,function*(){const r=yield this._dbPromise;return new Promise((i,s)=>{const u=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(n,e);u.onerror=c=>{s(c)},u.onsuccess=c=>{i()}})})}multiSet(e){return be(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const s=n.transaction([this._storeName],"readwrite"),o=s.objectStore(this._storeName),a=new Set;for(const[u,c]of e){const d=o.put(c,u);a.add(d)}for(const u of a)u.onerror=c=>{s.abort(),i(c)},u.onsuccess=c=>{a.delete(u),a.size===0&&r()}})})}removeItem(e){return be(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const a=n.transaction([this._storeName],"readwrite").objectStore(this._storeName).delete(e);a.onerror=u=>{i(u)},a.onsuccess=u=>{r()}})})}getAllKeys(){return be(this,void 0,void 0,function*(){const e=yield this._dbPromise;return new Promise((n,r)=>{const o=e.transaction([this._storeName],"readonly").objectStore(this._storeName).getAllKeys();o.onerror=a=>{r(a)},o.onsuccess=a=>{n(o.result.filter(u=>typeof u=="string"))}})})}}var Ta=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};class Nr{static getIsOnline(){return Ta(this,void 0,void 0,function*(){return navigator.onLine})}static listen(e){const n=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",n),addEventListener("offline",r),()=>{removeEventListener("online",n),removeEventListener("offline",r)}}}class xe extends Error{constructor(e,n){super(e),this.hint=n;const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,xe),this.name="InstantError"}get[Symbol.toStringTag](){return"InstantError"}}var wa=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};class Xe extends xe{constructor(e){var n;const r=((n=e.body)===null||n===void 0?void 0:n.message)||`API Error (${e.status})`;super(r,e.body.hint);const i=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,i),Error.captureStackTrace&&Error.captureStackTrace(this,Xe),this.name="InstantAPIError",this.status=e.status,this.body=e.body}get[Symbol.toStringTag](){return"InstantAPIError"}}function ce(t,e){return wa(this,void 0,void 0,function*(){const n=yield fetch(t,e),r=yield n.json();return n.status===200?Promise.resolve(r):Promise.reject(new Xe({status:n.status,body:r}))})}var De=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};function ma({apiURI:t,appId:e,email:n}){return ce(`${t}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n})})}function va(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,email:r,code:i,refreshToken:s}){return yield ce(`${e}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(Object.assign({"app-id":n,email:r,code:i},s?{"refresh-token":s}:{}))})})}function Sa(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,refreshToken:r}){return yield ce(`${e}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":n,"refresh-token":r})})})}function Oa(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n}){return yield ce(`${e}/runtime/auth/sign_in_guest`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":n})})})}function Kr(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,code:r,codeVerifier:i,refreshToken:s}){return yield ce(`${e}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,code:r,code_verifier:i,refresh_token:s})})})}function Ea(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,nonce:r,idToken:i,clientName:s,refreshToken:o}){return yield ce(`${e}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,nonce:r,id_token:i,client_name:s,refresh_token:o})})})}function Aa(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,refreshToken:r}){return yield ce(`${e}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,refresh_token:r})})})}var et=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};function ka(t){return et(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,file:i,refreshToken:s,contentType:o,contentDisposition:a}){const u={app_id:n,path:r,authorization:`Bearer ${s}`,"content-type":o||i.type};return a&&(u["content-disposition"]=a),yield ce(`${e}/storage/upload`,{method:"PUT",headers:u,body:i})})}function ja(t){return et(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,refreshToken:i}){const{data:s}=yield ce(`${e}/storage/files?app_id=${n}&filename=${encodeURIComponent(r)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${i}`}});return s})}function Ca(t){return et(this,arguments,void 0,function*({apiURI:e,appId:n,fileName:r,refreshToken:i,metadata:s={}}){const{data:o}=yield ce(`${e}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${i}`},body:JSON.stringify({app_id:n,filename:r})});return o})}function Pa(t,e){return et(this,void 0,void 0,function*(){return(yield fetch(t,{method:"PUT",body:e,headers:{"Content-Type":e.type}})).ok})}function Ia(t){return et(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,refreshToken:i}){const{data:s}=yield ce(`${e}/storage/signed-download-url?app_id=${n}&filename=${encodeURIComponent(r)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${i}`}});return s})}let bn=!1,Wr=!1,zr=!1;typeof window<"u"&&typeof window.localStorage<"u"&&(bn=!!window.localStorage.getItem("devBackend"),Wr=!!window.localStorage.getItem("__instantLogging"),zr=!!window.localStorage.getItem("__devtoolLocalDash"));function Vr(t,e){if(!e)return t;const n={};return e.forEach(r=>{n[r]=t[r]}),n}function Ma(t,e,n){var r,i;const s={peers:{}};if(e&&"user"in e?e.user:!0){const a=Vr((r=t.user)!==null&&r!==void 0?r:{},e==null?void 0:e.keys);s.user=Object.assign(Object.assign({},a),{peerId:n})}for(const a of Object.keys((i=t.peers)!==null&&i!==void 0?i:{})){const u=(e==null?void 0:e.peers)===void 0,c=Array.isArray(e==null?void 0:e.peers)&&(e==null?void 0:e.peers.includes(a));if(u||c){const d=Vr(t.peers[a],e==null?void 0:e.keys);s.peers[a]=Object.assign(Object.assign({},d),{peerId:a})}}return s}function Ra(t,e){if(t.isLoading!==e.isLoading||t.error!==e.error||(t.user||e.user)&&(!t.user||!e.user||!rr(t.user,e.user))||!nr(t.peers,e.peers))return!0;for(const r of Object.keys(t.peers))if(!rr(t.peers[r],e.peers[r]))return!0;return!1}class qr{constructor(){this.promise=new Promise((e,n)=>{this._resolve=e,this._reject=n})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}function Br(t,e=[]){t.forEach(n=>{const{data:r}=n,{"datalog-result":i}=r,{"join-rows":s}=i;for(const o of s)for(const a of o)e.push(a);Br(n["child-nodes"],e)})}function Gr(t){const e=[];return Br(t,e),e}function Qr(t){return Object.values(t.links).reduce((e,n)=>{var r,i,s,o;return(r=e[s=n.forward.on])!==null&&r!==void 0||(e[s]={}),e[n.forward.on][n.forward.label]={isForward:!0,isSingular:n.forward.has==="one",link:n},(i=e[o=n.reverse.on])!==null&&i!==void 0||(e[o]={}),e[n.reverse.on][n.reverse.label]={isForward:!1,isSingular:n.reverse.has==="one",link:n},e},{})}const _n="v0.22.88";function xa(t,e){return{info:t?(...n)=>console.info(...n,e()):()=>{},debug:t?(...n)=>console.debug(...n,e()):()=>{},error:t?(...n)=>console.error(...n,e()):()=>{}}}class H{constructor(e,n,r,i={indexed:!1,unique:!1}){this.valueType=e,this.required=n,this.isIndexed=r,this.config=i,this.metadata={}}clientRequired(){return new H(this.valueType,!1,this.isIndexed,this.config)}optional(){return new H(this.valueType,!1,this.isIndexed,this.config)}unique(){return new H(this.valueType,this.required,this.isIndexed,Object.assign(Object.assign({},this.config),{unique:!0}))}indexed(){return new H(this.valueType,this.required,!0,Object.assign(Object.assign({},this.config),{indexed:!0}))}}class Ot{constructor(e,n){this.attrs=e,this.links=n}asType(){return new Ot(this.attrs,this.links)}}class Et{constructor(e,n,r){this.entities=e,this.links=n,this.rooms=r}withRoomSchema(){return new Et(this.entities,this.links,{})}}class x extends Error{constructor(e,n){const r=n?`At path '${n}': ${e}`:e;super(r),this.name="QueryValidationError"}}const Hr=["where","order","limit","last","first","offset","after","before","fields","aggregate"],Da=t=>t.valueType||"unknown",Yr=(t,e,n=!1)=>{if(n||t==null)return!0;switch(e){case"string":return typeof t=="string";case"number":return typeof t=="number"&&!isNaN(t);case"boolean":return typeof t=="boolean";case"date":return t instanceof Date||typeof t=="string"||typeof t=="number";default:return!0}},$a=(t,e,n,r,i,s,o)=>{const a=s.valueType==="json",u=(c,d,f)=>{if(!Yr(f,d,a))throw new x(`Invalid value for operator '${c}' on attribute '${r}' in entity '${i}'. Expected ${d}, but received: ${typeof f}`,o)};switch(t){case"in":case"$in":if(!Array.isArray(e))throw new x(`Operator '${t}' for attribute '${r}' in entity '${i}' must be an array, but received: ${typeof e}`,o);for(const c of e)u(t,n,c);break;case"$not":case"$ne":case"$gt":case"$lt":case"$gte":case"$lte":u(t,n,e);break;case"$like":case"$ilike":if(u(t,"string",e),t==="$ilike"&&!s.isIndexed)throw new x(`Operator '${t}' can only be used with indexed attributes, but '${r}' in entity '${i}' is not indexed`,o);break;case"$isNull":u(t,"boolean",e);break;default:throw new x(`Unknown operator '${t}' for attribute '${r}' in entity '${i}'`,o)}},$e=(t,e,n,r,i)=>{const s=Da(n),o=n.valueType==="json";if(typeof t=="object"&&t!==null&&!Array.isArray(t)){if(o)return;const u=t;for(const[c,d]of Object.entries(u))$a(c,d,s,e,r,n,`${i}.${c}`)}else if(!Yr(t,s,o))throw new x(`Invalid value for attribute '${e}' in entity '${r}'. Expected ${s}, but received: ${typeof t}`,i)},Ua=(t,e,n,r,i)=>{const s=t.split(".");if(s.length<2)throw new x(`Invalid dot notation path '${t}'. Must contain at least one dot.`,i);let o=n;for(let d=0;d<s.length-1;d++){const f=s[d],l=r.entities[o];if(!l)throw new x(`Entity '${o}' does not exist in schema while traversing dot notation path '${t}'.`,i);const p=l.links[f];if(!p){const y=Object.keys(l.links);throw new x(`Link '${f}' does not exist on entity '${o}' in dot notation path '${t}'. Available links: ${y.length>0?y.join(", "):"none"}`,i)}o=p.entityName}const a=s[s.length-1],u=r.entities[o];if(!u)throw new x(`Target entity '${o}' does not exist in schema for dot notation path '${t}'.`,i);if(a==="id"){if(typeof e=="string"&&!Me(e))throw new x(`Invalid value for id field in entity '${o}'. Expected a UUID, but received: ${e}`,i);$e(e,t,new H("string",!1,!0),n,i);return}const c=u.attrs[a];if(Object.keys(u.links).includes(a)){if(typeof e=="string"&&!Me(e))throw new x(`Invalid value for link '${a}' in entity '${o}'. Expected a UUID, but received: ${e}`,i);$e(e,t,new H("string",!1,!0),n,i);return}if(!c){const d=Object.keys(u.attrs);throw new x(`Attribute '${a}' does not exist on entity '${o}' in dot notation path '${t}'. Available attributes: ${d.length>0?d.join(", ")+", id":"id"}`,i)}$e(e,t,c,n,i)},Jr=(t,e,n,r)=>{for(const[i,s]of Object.entries(t)){if(i==="or"||i==="and"){if(Array.isArray(s))for(const c of s)typeof c=="object"&&c!==null&&Jr(c,e,n,`${r}.${i}[${c}]`);continue}if(i==="id"){$e(s,"id",new H("string",!1,!0),e,`${r}.id`);continue}if(i.includes(".")){Ua(i,s,e,n,`${r}.${i}`);continue}const o=n.entities[e];if(!o)continue;const a=o.attrs[i],u=o.links[i];if(!a&&!u){const c=Object.keys(o.attrs),d=Object.keys(o.links);throw new x(`Attribute or link '${i}' does not exist on entity '${e}'. Available attributes: ${c.length>0?c.join(", "):"none"}. Available links: ${d.length>0?d.join(", "):"none"}`,`${r}.${i}`)}if(a)$e(s,i,a,e,`${r}.${i}`);else if(u){if(typeof s=="string"&&!Me(s))throw new x(`Invalid value for link '${i}' in entity '${e}'. Expected a UUID, but received: ${s}`,`${r}.${i}`);const c=new H("string",!1,!0);$e(s,i,c,e,`${r}.${i}`)}}},La=(t,e,n,r,i=0)=>{for(const o of Object.keys(t))if(!Hr.includes(o))throw new x(`Invalid query parameter '${o}' in $ object. Valid parameters are: ${Hr.join(", ")}. Found: ${o}`,r);const s=["offset","before","after","first","last"];for(const o of s)if(t[o]!==void 0&&i>0)throw new x(`'${o}' can only be used on top-level namespaces. It cannot be used in nested queries.`,r);if(t.where&&n){if(typeof t.where!="object"||t.where===null)throw new x(`'where' clause must be an object in entity '${e}', but received: ${typeof t.where}`,r?`${r}.where`:void 0);Jr(t.where,e,n,r?`${r}.where`:"where")}},Zr=(t,e,n,r,i=0)=>{var s;if(!t||typeof t!="object")throw new x(`Query part for entity '${e}' must be an object, but received: ${typeof t}`,r);for(const o of Object.keys(t))if(o!=="$"){if(n&&!(o in n.entities[e].links)){const u=Object.keys(n.entities[e].links);throw new x(`Link '${o}' does not exist on entity '${e}'. Available links: ${u.length>0?u.join(", "):"none"}`,`${r}.${o}`)}const a=t[o];if(typeof a=="object"&&a!==null){const u=(s=n==null?void 0:n.entities[e].links[o])===null||s===void 0?void 0:s.entityName;u&&Zr(a,u,n,`${r}.${o}`,i+1)}}else{const a=t[o];if(typeof a!="object"||a===null)throw new x(`Query parameter '$' must be an object in entity '${e}', but received: ${typeof a}`,`${r}.$`);La(a,e,n,`${r}.$`,i)}},Xr=(t,e)=>{if(typeof t!="object"||t===null)throw new x(`Query must be an object, but received: ${typeof t}${t===null?" (null)":""}`);if(Array.isArray(t))throw new x(`Query must be an object, but received: ${typeof t}`);const n=t;for(const r of Object.keys(n)){if(Array.isArray(t[r]))throw new x(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(typeof r!="string")throw new x(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(r!=="$$ruleParams"){if(e&&!e.entities[r]){const i=Object.keys(e.entities);throw new x(`Entity '${r}' does not exist in schema. Available entities: ${i.length>0?i.join(", "):"none"}`,r)}Zr(n[r],r,e,r,0)}}},ei=t=>typeof t!="string"?!1:vt(t)?!0:Me(t);class se extends Error{constructor(e){super(e),this.name="TransactionValidationError"}}const ti=t=>t.length>0?t.join(", "):"none",Fa=(t,e)=>new se(`Entity '${t}' does not exist in schema. Available entities: ${ti(e)}`),ni={string:t=>typeof t=="string",number:t=>typeof t=="number"&&!isNaN(t),boolean:t=>typeof t=="boolean",date:t=>t instanceof Date||typeof t=="string"||typeof t=="number",json:()=>!0},Na=(t,e)=>{var n,r;return t==null?!0:(r=(n=ni[e.valueType])===null||n===void 0?void 0:n.call(ni,t))!==null&&r!==void 0?r:!1},ri=(t,e)=>{const n=e.entities[t];if(!n)throw Fa(t,Object.keys(e.entities));return n},gn=(t,e,n)=>{const r=ri(t,n);if(typeof e!="object"||e===null)throw new se(`Arguments for data operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[i,s]of Object.entries(e)){if(i==="id")continue;const o=r.attrs[i];if(o&&!Na(s,o))throw new se(`Invalid value for attribute '${i}' in entity '${t}'. Expected ${o.valueType}, but received: ${typeof s}`)}},ii=(t,e,n)=>{const r=ri(t,n);if(typeof e!="object"||e===null)throw new se(`Arguments for link operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[i,s]of Object.entries(e)){if(!r.links[i]){const a=Object.keys(r.links);throw new se(`Link '${i}' does not exist on entity '${t}'. Available links: ${ti(a)}`)}if(s!=null){if(Array.isArray(s)){for(const a of s)if(!ei(a))throw new se(`Invalid entity ID in link '${i}' for entity '${t}'. Expected a UUID or a lookup, but received: ${a}`)}else if(!ei(s))throw new se(`Invalid UUID in link '${i}' for entity '${t}'. Expected a UUID, but received: ${s}`)}}},Ka={create:gn,update:gn,merge:gn,link:ii,unlink:ii,delete:()=>{}},Wa=(t,e)=>{if(!e)return;const[n,r,i,s]=t;if(!Array.isArray(i)&&!Me(i))throw new se(`Invalid id for entity '${r}'. Expected a UUID, but received: ${i}`);if(typeof r!="string")throw new se(`Entity name must be a string, but received: ${typeof r}`);const o=Ka[n];o&&s!==void 0&&o(r,s,e)},za=(t,e)=>{const n=Array.isArray(t)?t:[t];for(const r of n){if(!r||typeof r!="object")throw new se(`Transaction chunk must be an object, but received: ${typeof r}`);if(!Array.isArray(r.__ops))throw new se(`Transaction chunk must have __ops array, but received: ${typeof r.__ops}`);for(const i of r.__ops){if(!Array.isArray(i))throw new se(`Transaction operation must be an array, but received: ${typeof i}`);Wa(i,e)}}};var si=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};let oi=0;class ai{constructor(e){this.type="ws",this.id=`${this.type}_${oi++}`,this.conn=new WebSocket(e),this.conn.onopen=n=>{this.onopen&&this.onopen({target:this})},this.conn.onmessage=n=>{this.onmessage&&this.onmessage({target:this,message:JSON.parse(n.data.toString())})},this.conn.onclose=n=>{this.onclose&&this.onclose({target:this})},this.conn.onerror=n=>{this.onerror&&this.onerror({target:this})}}close(){this.conn.close()}isOpen(){var e;return this.conn.readyState===((e=WebSocket.OPEN)!==null&&e!==void 0?e:1)}isConnecting(){var e;return this.conn.readyState===((e=WebSocket.CONNECTING)!==null&&e!==void 0?e:0)}send(e){return this.conn.send(JSON.stringify(e))}}class Va{constructor(e,n){this.type="sse",this.initParams=null,this.sendQueue=[],this.closeFired=!1,this.sseInitTimeout=void 0,this.id=`${this.type}_${oi++}`,this.url=n,this.ES=e,this.conn=new e(n),this.sseInitTimeout=setTimeout(()=>{this.initParams||this.handleError()},1e4),this.conn.onmessage=r=>{const i=JSON.parse(r.data);if(Array.isArray(i))for(const s of i)this.handleMessage(s);else this.handleMessage(i)},this.conn.onerror=r=>{this.handleError()}}handleMessage(e){if(e.op==="sse-init"){this.initParams={machineId:e["machine-id"],sessionId:e["session-id"],sseToken:e["sse-token"]},this.onopen&&this.onopen({target:this}),clearTimeout(this.sseInitTimeout);return}this.onmessage&&this.onmessage({target:this,message:e})}handleError(){try{this.onerror&&this.onerror({target:this})}finally{this.handleClose()}}handleClose(){this.conn.close(),this.onclose&&!this.closeFired&&(this.closeFired=!0,this.onclose({target:this}))}postMessages(e){return si(this,void 0,void 0,function*(){var n,r,i;try{(yield fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id:(n=this.initParams)===null||n===void 0?void 0:n.machineId,session_id:(r=this.initParams)===null||r===void 0?void 0:r.sessionId,sse_token:(i=this.initParams)===null||i===void 0?void 0:i.sseToken,messages:e})})).ok||this.handleError()}catch{this.handleError()}})}flushQueue(){return si(this,void 0,void 0,function*(){if(this.sendPromise||!this.sendQueue.length)return;const e=this.sendQueue;this.sendQueue=[];const n=this.postMessages(e);this.sendPromise=n,n.then(()=>{this.sendPromise=null,this.flushQueue()})})}send(e){if(!this.isOpen()||!this.initParams)throw this.isConnecting()?new Error("Failed to execute 'send' on 'EventSource': Still in CONNECTING state."):this.conn.readyState===this.ES.CLOSED?new Error("EventSource is already in CLOSING or CLOSED state."):new Error("EventSource is in invalid state.");this.sendQueue.push(e),this.flushQueue()}isOpen(){return this.conn.readyState===this.ES.OPEN&&this.initParams!==null}isConnecting(){return this.conn.readyState===this.ES.CONNECTING||this.conn.readyState===this.ES.OPEN&&this.initParams===null}close(){this.handleClose()}}var ui=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};function qa(t,e){const n=t.values;if(n)for(const r of n.entities||[])r.store.useDateObjects=e,r.store.attrs=n.attrs,r.store=fr(r.store);return t}function Ba(t,e){var n,r;if(!((n=e.values)===null||n===void 0)&&n.entities){const i=[];for(const s of(r=e.values)===null||r===void 0?void 0:r.entities){const o=dr(s.store);delete o.attrs,i.push(Object.assign(Object.assign({},s),{store:o}))}return Object.assign(Object.assign({},e),{values:Object.assign(Object.assign({},e.values),{entities:i})})}else return e}function Ga(t,e,n){var r,i;const s=(r=e==null?void 0:e.state)===null||r===void 0?void 0:r.txId,o=(i=n==null?void 0:n.state)===null||i===void 0?void 0:i.txId;return s&&(!o||s>o)?e:o&&(!s||o>s)?n:e||n}function Tn(t,e){return Ir({store:e,pageInfo:null,aggregate:null},t.query).data[t.table][0]}function ci(t,e,n){var r;const i=(r=Te(e,t.table,"id"))===null||r===void 0?void 0:r.id;if(!i)return-1;const s=Ie(e.eav,[n,i,n]);return s?s[3]:-1}function di(t,e){for(const{action:n,triple:r}of e)switch(n){case"added":pr(t,r);break;case"removed":lr(t,r);break}}function Qa(t,e){var n,r,i,s;const o={};for(const{action:a,triple:u}of e){const[c,d,f]=u,l=(r=(n=t.attrs[d])===null||n===void 0?void 0:n["forward-identity"])===null||r===void 0?void 0:r[2];if(!l)continue;const p=(i=o[c])!==null&&i!==void 0?i:{};o[c]=p;const y=(s=p[l])!==null&&s!==void 0?s:{};switch(p[l]=y,a){case"added":y.newValue=f;break;case"removed":y.oldValue===void 0&&(y.oldValue=f);break}}for(const a of Object.keys(o)){const{oldValue:u,newValue:c}=o[a];u===c&&delete o[a]}return o}function At(t,e){return{[t.table]:e.map(n=>n.entity)}}function Ha(t,e){var n;if(t.orderFieldType)return t.orderFieldType;const r=t.orderField==="serverCreatedAt"?"number":(n=Te(e([]),t.table,t.orderField))===null||n===void 0?void 0:n["checked-data-type"];return t.orderFieldType=r,r}function Ya(t,e,n){const r=e;if(t.orderField==="serverCreatedAt"){n.sort(t.orderDirection==="asc"?function(o,a){return Je(o.entity.id,o.serverCreatedAt,a.entity.id,a.serverCreatedAt,r)}:function(o,a){return Je(a.entity.id,a.serverCreatedAt,o.entity.id,o.serverCreatedAt,r)});return}const i=t.orderField;n.sort(t.orderDirection==="asc"?function(o,a){return Je(o.entity.id,o.entity[i],a.entity.id,a.entity[i],r)}:function(o,a){return Je(a.entity.id,a.entity[i],o.entity.id,o.entity[i],r)})}D.SyncTableCallbackEventType=void 0,function(t){t.InitialSyncBatch="InitialSyncBatch",t.InitialSyncComplete="InitialSyncComplete",t.LoadFromStorage="LoadFromStorage",t.SyncTransaction="SyncTransaction",t.Error="Error"}(D.SyncTableCallbackEventType||(D.SyncTableCallbackEventType={}));class Ja{constructor(e,n,r,i,s){this.callbacks={},this.idToHash={},this.trySend=e,this.config=r,this.log=i,this.createStore=s,this.subs=new yn({persister:n,merge:Ga,serialize:Ba,parse:(o,a)=>qa(a,this.config.useDateObjects),objectSize:o=>{var a;return((a=o.values)===null||a===void 0?void 0:a.entities.length)||0},logger:i,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}})}beforeUnload(){this.subs.flush()}subscribe(e,n){const r=V(e);return this.callbacks[r]=this.callbacks[r]||[],this.callbacks[r].push(n),this.initSubscription(e,r,n),i=>{this.unsubscribe(r,n,i==null?void 0:i.keepSubscription)}}unsubscribe(e,n,r){const i=(this.callbacks[e]||[]).filter(s=>s!==n);if(this.callbacks[e]=i,!i.length){delete this.callbacks[e];const s=this.subs.currentValue[e];s!=null&&s.state&&this.clearSubscriptionData(s.state.subscriptionId,!!r),r||this.subs.updateInPlace(o=>{delete o[e]})}}sendStart(e){this.trySend(W(),{op:"start-sync",q:e})}sendResync(e,n,r){this.idToHash[n.subscriptionId]=e.hash,this.trySend(n.subscriptionId,{op:"resync-table","subscription-id":n.subscriptionId,"tx-id":r,token:n.token})}sendRemove(e,n){this.trySend(W(),{op:"remove-sync","subscription-id":e.subscriptionId,"keep-subscription":n})}initSubscription(e,n,r){return ui(this,void 0,void 0,function*(){var i,s,o,a;yield this.subs.waitForKeyToLoad(n);const u=this.subs.currentValue[n];if(u&&u.state&&u.state.txId){this.sendResync(u,u.state,u.state.txId),!((i=u.values)===null||i===void 0)&&i.entities&&r&&r({type:D.SyncTableCallbackEventType.LoadFromStorage,data:At(u,(s=u.values)===null||s===void 0?void 0:s.entities)});return}const c=Object.keys(e)[0],d=((a=(o=e[c])===null||o===void 0?void 0:o.$)===null||a===void 0?void 0:a.order)||{serverCreatedAt:"asc"},[f,l]=Object.entries(d)[0];this.subs.updateInPlace(p=>{p[n]={query:e,hash:n,table:c,orderDirection:l,orderField:f,createdAt:Date.now(),updatedAt:Date.now()}}),this.sendStart(e)})}flushPending(){return ui(this,void 0,void 0,function*(){for(const e of Object.keys(this.callbacks)){yield this.subs.waitForKeyToLoad(e);const n=this.subs.currentValue[e];n?yield this.initSubscription(n.query,n.hash):this.log.error("Missing sub for hash in flushPending",e)}})}onStartSyncOk(e){const n=e["subscription-id"],r=e.q,i=V(r);this.idToHash[n]=i,this.subs.updateInPlace(s=>{const o=s[i];if(!o)return this.log.error("Missing sub for hash",i,"subscription-id",n,"query",r),s;o.state={subscriptionId:n,token:e.token}})}notifyCbs(e,n){for(const r of this.callbacks[e]||[])r(n)}onSyncLoadBatch(e){var n;const r=e["subscription-id"],i=e["join-rows"],s=this.idToHash[r];if(!s){this.log.error("Missing hash for subscription",e);return}const o=[],a=this.subs.currentValue[s];if(!a){this.log.error("Missing sub for hash",s,e);return}const u=(n=a.values)!==null&&n!==void 0?n:{entities:[],attrs:this.createStore([]).attrs};a.values=u;const c=u.entities;for(const d of i){const f=this.createStore(d);u.attrs=f.attrs;const l=Tn(a,f);c.push({store:f,entity:l,serverCreatedAt:ci(a,f,l.id)}),o.push(l)}this.subs.updateInPlace(d=>{d[s]=a,d[s].updatedAt=Date.now()}),a.values&&this.notifyCbs(s,{type:D.SyncTableCallbackEventType.InitialSyncBatch,data:At(a,a.values.entities),batch:o})}onSyncInitFinish(e){var n;const r=e["subscription-id"],i=this.idToHash[r];if(!i){this.log.error("Missing hash for subscription",e);return}this.subs.updateInPlace(o=>{const a=o[i];if(!a){this.log.error("Missing sub for hash",i,e);return}const u=a.state;if(!u)return this.log.error("Sub never set init, missing result",a,e),o;u.txId=e["tx-id"],a.updatedAt=Date.now()});const s=this.subs.currentValue[i];s&&this.notifyCbs(i,{type:D.SyncTableCallbackEventType.InitialSyncComplete,data:At(s,((n=s.values)===null||n===void 0?void 0:n.entities)||[])})}onSyncUpdateTriples(e){var n,r,i;const s=e["subscription-id"],o=this.idToHash[s];if(!o){this.log.error("Missing hash for subscription",e);return}const a=this.subs.currentValue[o];if(!a){this.log.error("Missing sub for hash",o,e);return}const u=a.state;if(!u){this.log.error("Missing state for sub",a,e);return}for(const c of e.txes){if(u.txId&&u.txId>=c["tx-id"])continue;u.txId=c["tx-id"];const d=[],f={};for(const g of c.changes){const m=(n=f[g.triple[0]])!==null&&n!==void 0?n:[];f[g.triple[0]]=m,m.push(g)}const l=(r=a.values)!==null&&r!==void 0?r:{entities:[],attrs:this.createStore([]).attrs},p=l.entities;a.values=l;const y=[];e:for(const[g,m]of Object.entries(f))for(let E=0;E<p.length;E++){const S=p[E];if(js(S.store,g)){di(S.store,m);const M=Tn(a,S.store),U=Qa(S.store,m)[g];M?(y.push({oldEntity:S.entity,newEntity:M,changedFields:U||{}}),S.entity=M):d.push(E),delete f[g];continue e}}const b=[];for(const[g,m]of Object.entries(f)){const E=this.createStore([]);l.attrs=E.attrs,di(E,m);const S=Tn(a,E);if(!S){this.log.error("No entity found after applying change",{sub:a,changes:m,store:E});continue}p.push({store:E,entity:S,serverCreatedAt:ci(a,E,S.id)}),b.push(S)}const _=[];for(const g of d.sort().reverse())_.push(p[g].entity),p.splice(g,1);const w=Ha(a,this.createStore);Ya(a,w,p),this.notifyCbs(o,{type:D.SyncTableCallbackEventType.SyncTransaction,data:At(a,(i=a.values)===null||i===void 0?void 0:i.entities),added:b,removed:_,updated:y})}this.subs.updateInPlace(c=>{c[o]=a,c[o].updatedAt=Date.now()})}clearSubscriptionData(e,n){const r=this.idToHash[e];if(r){delete this.idToHash[e];const i=this.subs.currentValue[r];if(i.state&&this.sendRemove(i.state,n),n?this.subs.unloadKey(r):this.subs.updateInPlace(s=>{delete s[r]}),i)return i}}onStartSyncError(e){const n=V(e["original-event"].q),r={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa.",status:e.status,type:e.type,hint:e.hint},i=Object.keys(e["original-event"].q)[0];this.notifyCbs(n,{type:D.SyncTableCallbackEventType.Error,data:{[i]:[]},error:r})}onResyncError(e){const n=e["original-event"]["subscription-id"],r=this.clearSubscriptionData(n,!1);r&&this.initSubscription(r.query,r.hash)}}var N=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})},Za=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]]);return n};const _e={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},Xa=3e4,eu=3e4,tu=200,nu={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},wn="_instant_oauth_redirect",tt="currentUser";function ru({transportType:t,appId:e,apiURI:n,wsURI:r,EventSourceImpl:i}){if(!i)return new ai(`${r}?app_id=${e}`);switch(t){case"ws":return new ai(`${r}?app_id=${e}`);case"sse":return new Va(i,`${n}/runtime/sse?app_id=${e}`);default:throw new Error("Unknown transport type "+t)}}function iu(){return typeof window<"u"||typeof chrome<"u"}const fi={"set-presence":!0,"set-presence-ok":!0,"refresh-presence":!0,"patch-presence":!0};function su(t,e){var n;const r=typeof t=="string"?JSON.parse(t):t;if(!((n=r==null?void 0:r.result)===null||n===void 0)&&n.store){const i=r.result.store;r.result.store=fr(Object.assign(Object.assign({},i),{useDateObjects:e}))}return r}function ou(t,e){var n;const r=Object.assign({},e);return!((n=e.result)===null||n===void 0)&&n.store&&(r.result=Object.assign(Object.assign({},e.result),{store:dr(e.result.store)})),r}function au(t,e){switch(t){case"pendingMutations":return new Map(typeof e=="string"?JSON.parse(e):e);default:return e}}function uu(t,e){switch(t){case"pendingMutations":return[...e.entries()];default:return e}}function cu(t,e,n){const r=e==null?void 0:e.result,i=n==null?void 0:n.result;return r&&!i&&n&&(n.result=r),n||e}function li(t){return[...t].sort((e,n)=>{const[r,i]=e,[s,o]=n,a=i.order||0,u=o.order||0;return a==u?r<s?-1:r>s?1:0:a-u})}class du{constructor(e,n=Fr,r=Nr,i,s){var o,a,u;if(this._isOnline=!0,this._isShutdown=!1,this.status=_e.CONNECTING,this.queryCbs={},this.queryOnceDfds={},this.authCbs=[],this.attrsCbs=[],this.mutationErrorCbs=[],this.connectionStatusCbs=[],this.mutationDeferredStore=new Map,this._reconnectTimeoutId=null,this._reconnectTimeoutMs=0,this._transportType="ws",this._wsOk=null,this._localIdPromises={},this._errorMessage=null,this._oauthCallbackResponse=null,this._linkIndex=null,this._rooms={},this._roomsPendingLeave={},this._presence={},this._broadcastQueue=[],this._broadcastSubs={},this._currentUserCached={isLoading:!0,error:void 0,user:void 0},this._beforeUnloadCbs=[],this._dataForQueryCache={},this._inFlightMutationEventIds=new Set,this._onMergeKv=(c,d,f)=>{var l,p;switch(c){case"pendingMutations":{const y=(l=d==null?void 0:d.entries())!==null&&l!==void 0?l:[],b=(p=f==null?void 0:f.entries())!==null&&p!==void 0?p:[],_=new Map([...y,...b]);return(d?this._rewriteMutationsSorted(this.attrs,d):[]).forEach(([g,m])=>{var E;!(!((E=f==null?void 0:f.pendingMutations)===null||E===void 0)&&E.has(g))&&!m["tx-id"]&&this._sendMutation(g,m)}),_}default:return f||d}},this.getPreviousResult=c=>{var d;const f=V(c);return(d=this.dataForQuery(f))===null||d===void 0?void 0:d.data},this.notifyOne=c=>{var d,f;const l=(d=this.queryCbs[c])!==null&&d!==void 0?d:[],p=(f=this._dataForQueryCache[c])===null||f===void 0?void 0:f.data,y=this.dataForQuery(c);y!=null&&y.data&&(this._dataForQueryCache[c]=y,!bt(y.data,p)&&l.forEach(b=>b.cb(y.data)))},this.notifyOneQueryOnce=c=>{var d,f;const l=(d=this.queryOnceDfds[c])!==null&&d!==void 0?d:[],p=(f=this.dataForQuery(c))===null||f===void 0?void 0:f.data;l.forEach(y=>{this._completeQueryOnce(y.q,c,y.dfd),y.dfd.resolve(p)})},this.notifyQueryError=(c,d)=>{(this.queryCbs[c]||[]).forEach(l=>l.cb({error:d}))},this.pushTx=c=>{this.config.disableValidation||za(c,this.config.schema);try{const d=fa({attrs:this.optimisticAttrs(),schema:this.config.schema,stores:Object.values(this.querySubs.currentValue).map(f=>{var l;return(l=f==null?void 0:f.result)===null||l===void 0?void 0:l.store}),useDateObjects:this.config.useDateObjects},c);return this.pushOps(d)}catch(d){return this.pushOps([],d)}},this.pushOps=(c,d)=>{const f=W(),l=[...this._pendingMutations().values()],p=Math.max(0,...l.map(_=>_.order||0))+1,y={op:"transact","tx-steps":c,created:Date.now(),error:d,order:p};this._updatePendingMutations(_=>{_.set(f,y)});const b=new qr;return this.mutationDeferredStore.set(f,b),this._sendMutation(f,y),this.notifyAll(),b.promise},this._transportOnOpen=c=>{const d=c.target;if(this._transport!==d){this._log.info("[socket][open]",d.id,"skip; this is no longer the current transport");return}this._log.info("[socket][open]",this._transport.id),this._setStatus(_e.OPENED),this.getCurrentUser().then(f=>{var l;this._trySend(W(),{op:"init","app-id":this.config.appId,"refresh-token":(l=f.user)===null||l===void 0?void 0:l.refresh_token,versions:this.versions,"__admin-token":this.config.__adminToken})}).catch(f=>{this._log.error("[socket][error]",d.id,f)})},this._transportOnMessage=c=>{const d=c.target,f=c.message;if(this._transport!==d){this._log.info("[socket][message]",d.id,f,"skip; this is no longer the current transport");return}if(!this._wsOk&&d.type==="ws"&&(this._wsOk=!0),this._transportType="ws",Array.isArray(c.message))for(const l of c.message)this._handleReceive(d.id,l);else this._handleReceive(d.id,c.message)},this._transportOnError=c=>{const d=c.target;if(this._transport!==d){this._log.info("[socket][error]",d.id,"skip; this is no longer the current transport");return}this._log.error("[socket][error]",d.id,c)},this._scheduleReconnect=()=>{!this._wsOk&&this._transportType!=="sse"&&(this._transportType="sse",this._reconnectTimeoutMs=0),setTimeout(()=>{if(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),!this._isOnline){this._log.info("[socket][close]",this._transport.id,"we are offline, no need to start socket");return}this._startSocket()},this._reconnectTimeoutMs)},this._transportOnClose=c=>{const d=c.target;if(this._transport!==d){this._log.info("[socket][close]",d.id,"skip; this is no longer the current transport");return}this._setStatus(_e.CLOSED);for(const f of Object.values(this._rooms))f.isConnected=!1;if(this._isShutdown){this._log.info("[socket][close]",d.id,"Reactor has been shut down and will not reconnect");return}this._log.info("[socket][close]",d.id,"schedule reconnect, ms =",this._reconnectTimeoutMs),this._scheduleReconnect()},this._EventSource=s,this.config=Object.assign(Object.assign({},nu),e),this.queryCacheLimit=(o=this.config.queryCacheLimit)!==null&&o!==void 0?o:10,this._pendingTxCleanupTimeout=(a=this.config.pendingTxCleanupTimeout)!==null&&a!==void 0?a:eu,this._pendingMutationCleanupThreshold=(u=this.config.pendingMutationCleanupThreshold)!==null&&u!==void 0?u:tu,this._log=xa(e.verbose||bn||Wr,()=>this._reactorStats()),this.versions=Object.assign(Object.assign({},i||{}),{"@instantdb/core":_n}),this.config.schema&&(this._linkIndex=Qr(this.config.schema)),!!iu()){if(!e.appId)throw new Error("Instant must be initialized with an appId.");if(!Me(e.appId))throw new Error(`Instant must be initialized with a valid appId. \`${e.appId}\` is not a valid uuid.`);typeof BroadcastChannel=="function"&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",c=>N(this,void 0,void 0,function*(){var d;try{if(((d=c.data)===null||d===void 0?void 0:d.type)==="auth"){const f=yield this.getCurrentUser();this.updateUser(f.user)}}catch(f){this._log.error("[error] handle broadcast channel",f)}}))),this._initStorage(n),this._syncTable=new Ja(this._trySendAuthed.bind(this),new n(this.config.appId,"syncSubs"),{useDateObjects:this.config.useDateObjects},this._log,c=>gt(this.attrs,c,this.config.enableCardinalityInference,this._linkIndex,this.config.useDateObjects)),this._oauthCallbackResponse=this._oauthLoginInit(),this.getCurrentUser(),r.getIsOnline().then(c=>{this._isOnline=c,this._startSocket(),r.listen(d=>{d!==this._isOnline&&(this._log.info("[network] online =",d),this._isOnline=d,this._isOnline?this._startSocket():(this._log.info("Changing status from",this.status,"to",_e.CLOSED),this._setStatus(_e.CLOSED)))})}),typeof addEventListener<"u"&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload))}}updateSchema(e){this.config=Object.assign(Object.assign({},this.config),{schema:e,cardinalityInference:!!e}),this._linkIndex=e?Qr(this.config.schema):null}_reactorStats(){return{inFlightMutationCount:this._inFlightMutationEventIds.size,storedMutationCount:this._pendingMutations().size,transportType:this._transportType}}_onQuerySubLoaded(e){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyOne(e))}_initStorage(e){this.querySubs=new yn({persister:new e(this.config.appId,"querySubs"),merge:cu,serialize:ou,parse:(n,r)=>su(r,this.config.useDateObjects),objectSize:n=>{var r,i,s,o;return(o=(s=(i=(r=n.result)===null||r===void 0?void 0:r.store)===null||i===void 0?void 0:i.triples)===null||s===void 0?void 0:s.length)!==null&&o!==void 0?o:0},logger:this._log,preloadEntryCount:10,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}}),this.querySubs.onKeyLoaded=n=>this._onQuerySubLoaded(n),this.kv=new yn({persister:new e(this.config.appId,"kv"),merge:this._onMergeKv,serialize:uu,parse:au,objectSize:()=>0,logger:this._log,saveThrottleMs:100,idleCallbackMaxWaitMs:100,gc:null}),this.kv.onKeyLoaded=n=>{n==="pendingMutations"&&this.notifyAll()},this.kv.waitForKeyToLoad("pendingMutations"),this.kv.waitForKeyToLoad(tt),this._beforeUnloadCbs.push(()=>{this.kv.flush(),this.querySubs.flush()})}_beforeUnload(){for(const e of this._beforeUnloadCbs)e();this._syncTable.beforeUnload()}_finishTransaction(e,n,r){const i=this.mutationDeferredStore.get(n);this.mutationDeferredStore.delete(n);const s=e!=="error"&&e!=="timeout";if(!i&&!s&&console.error("Mutation failed",Object.assign({status:e,eventId:n},r)),!!i)if(s)i.resolve({status:e,eventId:n});else if(r!=null&&r.type){const{status:o}=r,a=Za(r,["status"]);i.reject(new Xe({body:a,status:o??0}))}else i.reject(new xe((r==null?void 0:r.message)||"Unknown error",r==null?void 0:r.hint))}_setStatus(e,n){this.status=e,this._errorMessage=n,this.notifyConnectionStatusSubs(e)}_flushEnqueuedRoomData(e){var n,r;const i=(r=(n=this._presence[e])===null||n===void 0?void 0:n.result)===null||r===void 0?void 0:r.user,s=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],i&&this._trySetPresence(e,i),s)for(const o of s){const{topic:a,roomType:u,data:c}=o;this._tryBroadcast(e,u,a,c)}}_handleReceive(e,n){var r,i,s,o,a,u;const c=!!this.config.schema&&("cardinalityInference"in this.config?!!this.config.cardinalityInference:!0);switch(fi[n.op]||this._log.info("[receive]",e,n.op,n),n.op){case"init-ok":{this._setStatus(_e.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(n.attrs),this._flushPendingMessages(),this._sessionId=n["session-id"];for(const l of Object.keys(this._rooms)){const p=(i=(r=this._presence[l])===null||r===void 0?void 0:r.result)===null||i===void 0?void 0:i.user;this._tryJoinRoom(l,p)}break}case"add-query-exists":{this.notifyOneQueryOnce(V(n.q));break}case"add-query-ok":{const{q:l,result:p}=n,y=V(l);if(!this._hasQueryListeners()&&!this.querySubs.currentValue[y])break;const b=(o=(s=p==null?void 0:p[0])===null||s===void 0?void 0:s.data)===null||o===void 0?void 0:o["page-info"],_=(u=(a=p==null?void 0:p[0])===null||a===void 0?void 0:a.data)===null||u===void 0?void 0:u.aggregate,w=Gr(p),g=gt(this.attrs,w,c,this._linkIndex,this.config.useDateObjects);this.querySubs.updateInPlace(m=>{if(!m[y]){this._log.info("Missing value in querySubs",{hash:y,q:l});return}m[y].result={store:g,pageInfo:b,aggregate:_,processedTxId:n["processed-tx-id"]}}),this._cleanupPendingMutationsQueries(),this.notifyOne(y),this.notifyOneQueryOnce(y),this._cleanupPendingMutationsTimeout();break}case"start-sync-ok":{this._syncTable.onStartSyncOk(n);break}case"sync-load-batch":{this._syncTable.onSyncLoadBatch(n);break}case"sync-init-finish":{this._syncTable.onSyncInitFinish(n);break}case"sync-update-triples":{this._syncTable.onSyncUpdateTriples(n);break}case"refresh-ok":{const{computations:l,attrs:p}=n,y=n["processed-tx-id"];p&&this._setAttrs(p),this._cleanupPendingMutationsTimeout();const b=this._rewriteMutations(this.attrs,this._pendingMutations(),y);b!==this._pendingMutations()&&this.kv.updateInPlace(g=>{g.pendingMutations=b});const _=li(b.entries()),w=l.map(g=>{var m,E,S,M;const U=g["instaql-query"],Y=g["instaql-result"],ut=V(U),Mt=Gr(Y),Dn=gt(this.attrs,Mt,c,this._linkIndex,this.config.useDateObjects),$n=this._applyOptimisticUpdates(Dn,_,y),Rt=(E=(m=Y==null?void 0:Y[0])===null||m===void 0?void 0:m.data)===null||E===void 0?void 0:E["page-info"],he=(M=(S=Y==null?void 0:Y[0])===null||S===void 0?void 0:S.data)===null||M===void 0?void 0:M.aggregate;return{q:U,hash:ut,store:$n,pageInfo:Rt,aggregate:he}});w.forEach(({hash:g,q:m,store:E,pageInfo:S,aggregate:M})=>{this.querySubs.updateInPlace(U=>{if(!U[g]){this._log.error("Missing value in querySubs",{hash:g,q:m});return}U[g].result={store:E,pageInfo:S,aggregate:M,processedTxId:y}})}),this._cleanupPendingMutationsQueries(),w.forEach(({hash:g})=>{this.notifyOne(g)});break}case"transact-ok":{const{"client-event-id":l,"tx-id":p}=n;this._inFlightMutationEventIds.delete(l);const b=this._rewriteMutations(this.attrs,this._pendingMutations()).get(l);if(!b)break;this._updatePendingMutations(w=>{w.set(l,Object.assign(Object.assign({},w.get(l)),{"tx-id":p,confirmed:Date.now()}))});const _=b["tx-steps"].filter(([w,...g])=>w==="add-attr").map(([w,g])=>g).concat(Object.values(this.attrs));this._setAttrs(_),this._finishTransaction("synced",l),this._cleanupPendingMutationsTimeout();break}case"patch-presence":{const l=n["room-id"];this._trySetRoomConnected(l,!0),this._patchPresencePeers(l,n.edits),this._notifyPresenceSubs(l);break}case"refresh-presence":{const l=n["room-id"];this._trySetRoomConnected(l,!0),this._setPresencePeers(l,n.data),this._notifyPresenceSubs(l);break}case"server-broadcast":{const l=n["room-id"],p=n.topic;this._trySetRoomConnected(l,!0),this._notifyBroadcastSubs(l,p,n);break}case"join-room-ok":{const l=n["room-id"];if(!this._rooms[l]){this._roomsPendingLeave[l]&&(this._tryLeaveRoom(l),delete this._roomsPendingLeave[l]);break}this._trySetRoomConnected(l,!0),this._flushEnqueuedRoomData(l);break}case"leave-room-ok":{const l=n["room-id"];this._trySetRoomConnected(l,!1);break}case"join-room-error":const d=n["room-id"],f=this._rooms[d];f&&(f.error=n.error),this._notifyPresenceSubs(d);break;case"error":this._handleReceiveError(n);break;default:this._log.info("Uknown op",n.op,n);break}}_pendingMutations(){var e;return(e=this.kv.currentValue.pendingMutations)!==null&&e!==void 0?e:new Map}_updatePendingMutations(e){this.kv.updateInPlace(n=>{var r;const i=(r=n.pendingMutations)!==null&&r!==void 0?r:new Map;n.pendingMutations=i,e(i)})}_handleMutationError(e,n,r){const i=this._pendingMutations().get(n);if(i&&(e!=="timeout"||!i["tx-id"])){this._updatePendingMutations(o=>(o.delete(n),o)),this._inFlightMutationEventIds.delete(n);const s={message:r.message,hint:r.hint};this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(s),this._finishTransaction(e,n,r)}}_handleReceiveError(e){var n,r,i,s,o,a,u;console.log("error",e);const c=e["client-event-id"];this._inFlightMutationEventIds.delete(c);const d=this._pendingMutations().get(c),f={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(e.hint&&(f.hint=e.hint),d){this._handleMutationError("error",c,e);return}if(!((n=e["original-event"])===null||n===void 0)&&n.hasOwnProperty("q")&&((r=e["original-event"])===null||r===void 0?void 0:r.op)==="add-query"){const y=(i=e["original-event"])===null||i===void 0?void 0:i.q,b=V(y);this.notifyQueryError(V(y),f),this.notifyQueryOnceError(y,b,c,f);return}if(((s=e["original-event"])===null||s===void 0?void 0:s.op)==="init"){if(e.type==="record-not-found"&&((o=e.hint)===null||o===void 0?void 0:o["record-type"])==="app-user"){this.changeCurrentUser(null);return}this._setStatus(_e.ERRORED,f),this.notifyAll();return}if(((a=e["original-event"])===null||a===void 0?void 0:a.op)==="resync-table"){this._syncTable.onResyncError(e);return}if(((u=e["original-event"])===null||u===void 0?void 0:u.op)==="start-sync"){this._syncTable.onStartSyncError(e);return}const p=Object.assign({},e);delete p.message,delete p.hint,console.error(e.message,p),e.hint&&console.error(`This error comes with some debugging information. Here it is: 
`,e.hint)}notifyQueryOnceError(e,n,r,i){var s;const o=(s=this.queryOnceDfds[n])===null||s===void 0?void 0:s.find(a=>a.eventId===r);o&&(o.dfd.reject(i),this._completeQueryOnce(e,n,o.dfd))}_setAttrs(e){this.attrs=e.reduce((n,r)=>(n[r.id]=r,n),{}),this.notifyAttrsSubs()}_startQuerySub(e,n){const r=W();return this.querySubs.updateInPlace(i=>{i[n]=i[n]||{q:e,result:null,eventId:r},i[n].lastAccessed=Date.now()}),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeTable(e,n){return this._syncTable.subscribe(e,n)}subscribeQuery(e,n,r){var i;this.config.disableValidation||Xr(e,this.config.schema),r&&"ruleParams"in r&&(e=Object.assign({$$ruleParams:r.ruleParams},e));const s=V(e),o=this.getPreviousResult(e);return o&&n(o),this.queryCbs[s]=(i=this.queryCbs[s])!==null&&i!==void 0?i:[],this.queryCbs[s].push({q:e,cb:n}),this._startQuerySub(e,s),()=>{this._unsubQuery(e,s,n)}}queryOnce(e,n){var r;this.config.disableValidation||Xr(e,this.config.schema),n&&"ruleParams"in n&&(e=Object.assign({$$ruleParams:n.ruleParams},e));const i=new qr;if(!this._isOnline)return i.reject(new Error("We can't run `queryOnce`, because the device is offline.")),i.promise;if(!this.querySubs)return i.reject(new Error("We can't run `queryOnce` on the backend. Use adminAPI.query instead: https://www.instantdb.com/docs/backend#query")),i.promise;const s=V(e),o=this._startQuerySub(e,s);return this.queryOnceDfds[s]=(r=this.queryOnceDfds[s])!==null&&r!==void 0?r:[],this.queryOnceDfds[s].push({q:e,dfd:i,eventId:o}),setTimeout(()=>i.reject(new Error("Query timed out")),Xa),i.promise}_completeQueryOnce(e,n,r){this.queryOnceDfds[n]&&(this.queryOnceDfds[n]=this.queryOnceDfds[n].filter(i=>i.dfd!==r),this._cleanupQuery(e,n))}_unsubQuery(e,n,r){this.queryCbs[n]&&(this.queryCbs[n]=this.queryCbs[n].filter(i=>i.cb!==r),this._cleanupQuery(e,n))}_hasQueryListeners(e){var n,r;return!!(!((n=this.queryCbs[e])===null||n===void 0)&&n.length||!((r=this.queryOnceDfds[e])===null||r===void 0)&&r.length)}_cleanupQuery(e,n){this._hasQueryListeners(n)||(delete this.queryCbs[n],delete this.queryOnceDfds[n],delete this._dataForQueryCache[n],this.querySubs.unloadKey(n),this._trySendAuthed(W(),{op:"remove-query",q:e}))}_rewriteMutations(e,n,r){if(!e)return n;if(!n)return new Map;const i=d=>{const[f,l,p]=d["forward-identity"];return B(e,l,p)},s=d=>{const[f,l,p]=d["forward-identity"];return Oe(e,l,p)},o={attrIdMap:{},refSwapAttrIds:new Set};let a=!1;const u=(d,f)=>{const l=[];for(const p of d){const[y]=p;if(y==="add-attr"){const[_,w]=p,g=i(w);if(g&&w.id!==g.id){o.attrIdMap[w.id]=g.id,a=!0;continue}if(w["value-type"]==="ref"){const m=s(w);if(m){o.attrIdMap[w.id]=m.id,o.refSwapAttrIds.add(w.id),a=!0;continue}}}if(r&&f&&r>=f&&y==="add-attr"||y==="update-attr"||y==="delete-attr"){a=!0;continue}const b=a?Ko(o,p):p;l.push(b)}return a?l:d},c=new Map;for(const[d,f]of n.entries())c.set(d,Object.assign(Object.assign({},f),{"tx-steps":u(f["tx-steps"],f["tx-id"])}));return a?c:n}_rewriteMutationsSorted(e,n){return li(this._rewriteMutations(e,n).entries())}optimisticAttrs(){var e;const n=[...this._pendingMutations().values()].flatMap(a=>a["tx-steps"]),r=new Set(n.filter(([a,u])=>a==="delete-attr").map(([a,u])=>u)),i=[];for(const[a,u]of n)if(a==="add-attr")i.push(u);else if(a==="update-attr"&&u.id&&(!((e=this.attrs)===null||e===void 0)&&e[u.id])){const c=Object.assign(Object.assign({},this.attrs[u.id]),u);i.push(c)}const s=[...Object.values(this.attrs||{}),...i].filter(a=>!r.has(a.id));return Object.fromEntries(s.map(a=>[a.id,a]))}dataForQuery(e){const n=this._errorMessage;if(n)return{error:n};if(!this.querySubs||!this.kv.currentValue.pendingMutations)return;const r=this.querySubs.version(),i=this.querySubs.currentValue,s=this.kv.version(),o=this._pendingMutations(),{q:a,result:u}=i[e]||{};if(!u)return;const c=this._dataForQueryCache[e];if(c&&r===c.querySubVersion&&s===c.pendingMutationsVersion)return c;const{store:d,pageInfo:f,aggregate:l,processedTxId:p}=u,y=this._rewriteMutationsSorted(d.attrs,o),b=this._applyOptimisticUpdates(d,y,p);return{data:Ir({store:b,pageInfo:f,aggregate:l},a),querySubVersion:r,pendingMutationsVersion:s}}_applyOptimisticUpdates(e,n,r){for(const[i,s]of n)(!s["tx-id"]||r&&s["tx-id"]>r)&&(e=Ns(e,s["tx-steps"]));return e}notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.querySubs.waitForKeyToLoad(e).then(()=>this.notifyOne(e)).catch(()=>this.notifyOne(e))})}loadedNotifyAll(){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyAll()).catch(()=>this.notifyAll())}shutdown(){var e;this._log.info("[shutdown]",this.config.appId),this._isShutdown=!0,(e=this._transport)===null||e===void 0||e.close()}_sendMutation(e,n){if(n.error){this._handleMutationError("error",e,{message:n.error.message});return}if(this.status!==_e.AUTHENTICATED){this._finishTransaction("enqueued",e);return}const r=Math.max(6e3,Math.min(this._inFlightMutationEventIds.size+1,this._pendingMutations().size+1)*6e3);this._isOnline?(this._trySend(e,n),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(i=>this.querySubs.currentValue[i]).filter(i=>i).forEach(({eventId:i,q:s})=>{this._trySendAuthed(i,{op:"add-query",q:s})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:i,q:s})=>{this._trySendAuthed(i,{op:"add-query",q:s})}),this._rewriteMutationsSorted(this.attrs,this._pendingMutations()).forEach(([i,s])=>{s["tx-id"]||this._sendMutation(i,s)}),this._syncTable.flushPending()}_cleanupPendingMutationsQueries(){let e=Number.MAX_SAFE_INTEGER;for(const{result:n}of Object.values(this.querySubs.currentValue))n!=null&&n.processedTxId&&(e=Math.min(e,n==null?void 0:n.processedTxId));this._updatePendingMutations(n=>{for(const[r,i]of Array.from(n.entries()))i["tx-id"]&&i["tx-id"]<=e&&n.delete(r)})}_cleanupPendingMutationsTimeout(){if(this._pendingMutations().size<this._pendingMutationCleanupThreshold)return;const e=Date.now();this._updatePendingMutations(n=>{for(const[r,i]of Array.from(n.entries()))i.confirmed&&i.confirmed+this._pendingTxCleanupTimeout<e&&n.delete(r)})}_trySendAuthed(...e){this.status===_e.AUTHENTICATED&&this._trySend(...e)}_trySend(e,n,r){if(this._transport.isOpen()){switch(fi[n.op]||this._log.info("[send]",this._transport.id,n.op,n),n.op){case"transact":{this._inFlightMutationEventIds.add(e);break}case"init":this._inFlightMutationEventIds.clear()}this._transport.send(Object.assign({"client-event-id":e},n))}}_startSocket(){if(this._wsOk=null,this._isShutdown){this._log.info("[socket][start]",this.config.appId,"Reactor has been shut down and will not start a new socket");return}if(this._transport&&this._transport.isConnecting()){this._log.info("[socket][start]",this._transport.id,"maintained as current transport, we were still in a connecting state");return}const e=this._transport;this._transport=ru({transportType:this._transportType,appId:this.config.appId,apiURI:this.config.apiURI,wsURI:this.config.websocketURI,EventSourceImpl:this._EventSource}),this._transport.onopen=this._transportOnOpen,this._transport.onmessage=this._transportOnMessage,this._transport.onclose=this._transportOnClose,this._transport.onerror=this._transportOnError,this._log.info("[socket][start]",this._transport.id),e!=null&&e.isOpen()&&(this._log.info("[socket][start]",this._transport.id,"close previous transport id = ",e.id),e.close())}getLocalId(e){return N(this,void 0,void 0,function*(){const n=`localToken_${e}`;if(this.kv.currentValue[n])return this.kv.currentValue[n];const r=yield this.kv.waitForKeyToLoad(n);if(r)return r;const i=W();return this.kv.updateInPlace(s=>{s[n]||(s[n]=i)}),yield this.kv.waitForKeyToLoad(n)})}_replaceUrlAfterOAuth(){if(typeof URL>"u")return;const e=new URL(window.location.href);if(e.searchParams.get(wn)){const n=e.toString();e.searchParams.delete(wn),e.searchParams.delete("code"),e.searchParams.delete("error");const r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),typeof navigation=="object"&&typeof navigation.addEventListener=="function"&&typeof navigation.removeEventListener=="function"){let i=!1;const s=o=>{var a;i||(i=!0,navigation.removeEventListener("navigate",s),!o.userInitiated&&o.navigationType==="replace"&&((a=o.destination)===null||a===void 0?void 0:a.url)===n&&history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",s)}}}_oauthLoginInit(){return N(this,void 0,void 0,function*(){var e,n,r,i;if(typeof window>"u"||typeof window.location>"u"||typeof URLSearchParams>"u")return null;const s=new URLSearchParams(window.location.search);if(!s.get(wn))return null;const o=s.get("error");if(o)return this._replaceUrlAfterOAuth(),{error:{message:o}};const a=s.get("code");if(!a)return null;this._replaceUrlAfterOAuth();try{const u=yield this._getCurrentUser(),c=(u==null?void 0:u.type)==="guest",{user:d}=yield Kr({apiURI:this.config.apiURI,appId:this.config.appId,code:a,refreshToken:c?u.refresh_token:void 0});return this.setCurrentUser(d),null}catch(u){return((e=u==null?void 0:u.body)===null||e===void 0?void 0:e.type)==="record-not-found"&&((r=(n=u==null?void 0:u.body)===null||n===void 0?void 0:n.hint)===null||r===void 0?void 0:r["record-type"])==="app-oauth-code"&&(yield this._hasCurrentUser())?null:{error:{message:((i=u==null?void 0:u.body)===null||i===void 0?void 0:i.message)||"Error logging in."}}}})}_waitForOAuthCallbackResponse(){return N(this,void 0,void 0,function*(){return yield this._oauthCallbackResponse})}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(n=>n!==e)}}subscribeAuth(e){this.authCbs.push(e);const n=this._currentUserCached;n.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(i=>{r||bt(i,n)||e(i)}),()=>{r=!0,this.authCbs=this.authCbs.filter(i=>i!==e)}}getAuth(){return N(this,void 0,void 0,function*(){const{user:e,error:n}=yield this.getCurrentUser();if(n)throw new xe("Could not get current user: "+n.message);return e})}subscribeConnectionStatus(e){return this.connectionStatusCbs.push(e),()=>{this.connectionStatusCbs=this.connectionStatusCbs.filter(n=>n!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(n=>n!==e)}}notifyAuthSubs(e){this.authCbs.forEach(n=>n(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(n=>n(e))}notifyAttrsSubs(){if(!this.attrs)return;const e=this.optimisticAttrs();this.attrsCbs.forEach(n=>n(e))}notifyConnectionStatusSubs(e){this.connectionStatusCbs.forEach(n=>n(e))}setCurrentUser(e){return N(this,void 0,void 0,function*(){this.kv.updateInPlace(n=>{n[tt]=e}),yield this.kv.waitForKeyToLoad(tt)})}getCurrentUserCached(){return this._currentUserCached}_getCurrentUser(){return N(this,void 0,void 0,function*(){const e=yield this.kv.waitForKeyToLoad(tt);return typeof e=="string"?JSON.parse(e):e})}getCurrentUser(){return N(this,void 0,void 0,function*(){const e=yield this._waitForOAuthCallbackResponse();if(e!=null&&e.error){const n={error:e.error,user:void 0};return this._currentUserCached=Object.assign({isLoading:!1},n),n}try{const r={user:yield this._getCurrentUser(),error:void 0};return this._currentUserCached=Object.assign({isLoading:!1},r),r}catch(n){return{user:void 0,isLoading:!1,error:{message:(n==null?void 0:n.message)||"Error loading user"}}}})}_hasCurrentUser(){return N(this,void 0,void 0,function*(){const e=yield this.kv.waitForKeyToLoad(tt);return typeof e=="string"?JSON.parse(e)!=null:e!=null})}changeCurrentUser(e){return N(this,void 0,void 0,function*(){var n;const{user:r}=yield this.getCurrentUser();if(!bt(r,e)){yield this.setCurrentUser(e),this.updateUser(e);try{(n=this._broadcastChannel)===null||n===void 0||n.postMessage({type:"auth"})}catch(i){console.error("Error posting message to broadcast channel",i)}}})}updateUser(e){const n={error:void 0,user:e};this._currentUserCached=Object.assign({isLoading:!1},n),this._dataForQueryCache={},this.querySubs.updateInPlace(r=>{Object.keys(r).forEach(i=>{delete r[i].result})}),this._reconnectTimeoutMs=0,this._transport.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(n)}sendMagicCode({email:e}){return ma({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}signInWithMagicCode(e){return N(this,arguments,void 0,function*({email:n,code:r}){var i;const s=yield this.getCurrentUser(),o=((i=s==null?void 0:s.user)===null||i===void 0?void 0:i.type)==="guest",a=yield va({apiURI:this.config.apiURI,appId:this.config.appId,email:n,code:r,refreshToken:o?s.user.refresh_token:void 0});return yield this.changeCurrentUser(a.user),a})}signInWithCustomToken(e){return N(this,void 0,void 0,function*(){const n=yield Sa({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});return yield this.changeCurrentUser(n.user),n})}signInAsGuest(){return N(this,void 0,void 0,function*(){const e=yield Oa({apiURI:this.config.apiURI,appId:this.config.appId});return yield this.changeCurrentUser(e.user),e})}potentiallyInvalidateToken(e,n){var r;const i=(r=e==null?void 0:e.user)===null||r===void 0?void 0:r.refresh_token;if(!i)return;if(n.invalidateToken===!1){this._log.info("[auth-invalidate] skipped invalidateToken");return}Aa({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:i}).then(()=>{this._log.info("[auth-invalidate] completed invalidateToken")}).catch(o=>{})}signOut(e){return N(this,void 0,void 0,function*(){const n=yield this.getCurrentUser();this.potentiallyInvalidateToken(n,e),yield this.changeCurrentUser(null)})}createAuthorizationURL({clientName:e,redirectURL:n}){const{apiURI:r,appId:i}=this.config;return`${r}/runtime/oauth/start?app_id=${i}&client_name=${e}&redirect_uri=${n}`}exchangeCodeForToken(e){return N(this,arguments,void 0,function*({code:n,codeVerifier:r}){var i;const s=yield this.getCurrentUser(),o=((i=s==null?void 0:s.user)===null||i===void 0?void 0:i.type)==="guest",a=yield Kr({apiURI:this.config.apiURI,appId:this.config.appId,code:n,codeVerifier:r,refreshToken:o?s.user.refresh_token:void 0});return yield this.changeCurrentUser(a.user),a})}issuerURI(){const{apiURI:e,appId:n}=this.config;return`${e}/runtime/${n}`}signInWithIdToken(e){return N(this,arguments,void 0,function*({idToken:n,clientName:r,nonce:i}){var s;const o=yield this.getCurrentUser(),a=(s=o==null?void 0:o.user)===null||s===void 0?void 0:s.refresh_token,u=yield Ea({apiURI:this.config.apiURI,appId:this.config.appId,idToken:n,clientName:r,nonce:i,refreshToken:a});return yield this.changeCurrentUser(u.user),u})}joinRoom(e,n){let r=!1;this._rooms[e]||(r=!0,this._rooms[e]={isConnected:!1,error:void 0}),this._presence[e]=this._presence[e]||{};const i=this._presence[e].result;return n&&!i&&(this._presence[e].result=this._presence[e].result||{},this._presence[e].result.user=n,this._notifyPresenceSubs(e)),r&&this._tryJoinRoom(e,n),()=>{this._cleanupRoom(e)}}_cleanupRoom(e){var n,r,i,s;if(!(!((r=(n=this._presence[e])===null||n===void 0?void 0:n.handlers)===null||r===void 0)&&r.length)&&!Object.keys((i=this._broadcastSubs[e])!==null&&i!==void 0?i:{}).length){const o=(s=this._rooms[e])===null||s===void 0?void 0:s.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],o?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,n,r={}){const i=this._rooms[n],s=this._presence[n];return!i||!s||!s.result?null:Object.assign(Object.assign({},Ma(s.result,r,this._sessionId)),{isLoading:!i.isConnected,error:i.error})}publishPresence(e,n,r){const i=this._rooms[n],s=this._presence[n];if(!i||!s)return;s.result=s.result||{};const o=Object.assign(Object.assign({},s.result.user),r);s.result.user=o,i.isConnected&&(this._trySetPresence(n,o),this._notifyPresenceSubs(n))}_trySetPresence(e,n){this._trySendAuthed(W(),{op:"set-presence","room-id":e,data:n})}_tryJoinRoom(e,n){this._trySendAuthed(W(),{op:"join-room","room-id":e,data:n}),delete this._roomsPendingLeave[e]}_tryLeaveRoom(e){this._trySendAuthed(W(),{op:"leave-room","room-id":e})}_trySetRoomConnected(e,n){const r=this._rooms[e];r&&(r.isConnected=n)}subscribePresence(e,n,r,i){const s=this.joinRoom(n,r.initialPresence||r.initialData),o=Object.assign(Object.assign({},r),{roomId:n,cb:i,prev:null});return this._presence[n]=this._presence[n]||{},this._presence[n].handlers=this._presence[n].handlers||[],this._presence[n].handlers.push(o),this._notifyPresenceSub(n,o),()=>{var a,u,c;this._presence[n].handlers=(c=(u=(a=this._presence[n])===null||a===void 0?void 0:a.handlers)===null||u===void 0?void 0:u.filter(d=>d!==o))!==null&&c!==void 0?c:[],s()}}_notifyPresenceSubs(e){var n,r;(r=(n=this._presence[e])===null||n===void 0?void 0:n.handlers)===null||r===void 0||r.forEach(i=>{this._notifyPresenceSub(e,i)})}_notifyPresenceSub(e,n){const r=this.getPresence("",e,n);r&&(n.prev&&!Ra(r,n.prev)||(n.prev=r,n.cb(r)))}_patchPresencePeers(e,n){var r,i,s;const o=((i=(r=this._presence[e])===null||r===void 0?void 0:r.result)===null||i===void 0?void 0:i.peers)||{};let a=Object.fromEntries(Object.entries(o).map(([c,d])=>[c,{data:d}]));(s=this._presence[e])===null||s===void 0||s.result;const u=yt(a,c=>{for(let[d,f,l]of n)switch(f){case"+":us(c,d,l);break;case"r":sr(c,d,l);break;case"-":or(c,d);break}delete c[this._sessionId]});this._setPresencePeers(e,u)}_setPresencePeers(e,n){const r=Object.assign({},n);delete r[this._sessionId];const i=Object.fromEntries(Object.entries(r).map(([s,o])=>[s,o.data]));this._presence=yt(this._presence,s=>{sr(s,[e,"result","peers"],i)})}publishTopic({roomType:e,roomId:n,topic:r,data:i}){var s;const o=this._rooms[n];if(o){if(!o.isConnected){this._broadcastQueue[n]=(s=this._broadcastQueue[n])!==null&&s!==void 0?s:[],this._broadcastQueue[n].push({topic:r,roomType:e,data:i});return}this._tryBroadcast(n,e,r,i)}}_tryBroadcast(e,n,r,i){this._trySendAuthed(W(),{op:"client-broadcast","room-id":e,roomType:n,topic:r,data:i})}subscribeTopic(e,n,r){const i=this.joinRoom(e);return this._broadcastSubs[e]=this._broadcastSubs[e]||{},this._broadcastSubs[e][n]=this._broadcastSubs[e][n]||[],this._broadcastSubs[e][n].push(r),this._presence[e]=this._presence[e]||{},()=>{this._broadcastSubs[e][n]=this._broadcastSubs[e][n].filter(s=>s!==r),this._broadcastSubs[e][n].length||delete this._broadcastSubs[e][n],i()}}_notifyBroadcastSubs(e,n,r){var i,s,o;(o=(s=(i=this._broadcastSubs)===null||i===void 0?void 0:i[e])===null||s===void 0?void 0:s[n])===null||o===void 0||o.forEach(a=>{var u,c,d,f,l,p;const y=(u=r.data)===null||u===void 0?void 0:u.data,b=r.data["peer-id"]===this._sessionId?(d=(c=this._presence[e])===null||c===void 0?void 0:c.result)===null||d===void 0?void 0:d.user:(p=(l=(f=this._presence[e])===null||f===void 0?void 0:f.result)===null||l===void 0?void 0:l.peers)===null||p===void 0?void 0:p[r.data["peer-id"]];return a(y,b)})}uploadFile(e,n,r){return N(this,void 0,void 0,function*(){var i;const s=yield this.getCurrentUser(),o=(i=s==null?void 0:s.user)===null||i===void 0?void 0:i.refresh_token;return ka(Object.assign(Object.assign({},r),{apiURI:this.config.apiURI,appId:this.config.appId,path:e,file:n,refreshToken:o}))})}deleteFile(e){return N(this,void 0,void 0,function*(){var n;const r=yield this.getCurrentUser(),i=(n=r==null?void 0:r.user)===null||n===void 0?void 0:n.refresh_token;return yield ja({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:i})})}upload(e,n){return N(this,void 0,void 0,function*(){var r;const i=yield this.getCurrentUser(),s=(r=i==null?void 0:i.user)===null||r===void 0?void 0:r.refresh_token,o=e||n.name,a=yield Ca({apiURI:this.config.apiURI,appId:this.config.appId,fileName:o,refreshToken:s});return yield Pa(a,n)})}getDownloadUrl(e){return N(this,void 0,void 0,function*(){var n;const r=yield this.getCurrentUser(),i=(n=r==null?void 0:r.user)===null||n===void 0?void 0:n.refresh_token;return yield Ia({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:i})})}}function fu(t,e){return new Et(hi(t,e),e,void 0)}function lu(t){return new Ot(t,{})}function hu(){return new H("string",!0,!1)}function pu(){return new H("number",!0,!1)}function yu(){return new H("boolean",!0,!1)}function bu(){return new H("date",!0,!1)}function _u(){return new H("json",!0,!1)}function gu(){return new H("json",!0,!1)}function hi(t,e){var n,r,i,s;const o={fwd:{},rev:{}};for(const u of Object.values(e))(n=o.fwd)[r=u.forward.on]||(n[r]={}),(i=o.rev)[s=u.reverse.on]||(i[s]={}),o.fwd[u.forward.on][u.forward.label]={entityName:u.reverse.on,cardinality:u.forward.has},o.rev[u.reverse.on][u.reverse.label]={entityName:u.forward.on,cardinality:u.reverse.has};return Object.fromEntries(Object.entries(t).map(([u,c])=>[u,new Ot(c.attrs,Object.assign(Object.assign({},o.fwd[u]),o.rev[u]))]))}function Tu({entities:t,links:e,rooms:n}){const r=e??{},i=n??{};return new Et(hi(t,r),r,i)}const wu={graph:fu,schema:Tu,entity:lu,string:hu,number:pu,boolean:yu,date:bu,json:_u,any:gu};let kt;function mu(t,e){kt==null||kt.dispose();const n=ku(e),r=Ou(e,a),i=Su(vu(t));function s(d){var f;d.source===i.element.contentWindow&&((f=d.data)===null||f===void 0?void 0:f.type)==="close"&&n.isVisible()&&a()}function o(d){const f=d.shiftKey&&d.ctrlKey&&d.key==="0",l=d.key==="Escape"||d.key==="Esc";(f||l&&n.isVisible())&&a()}function a(){n.isVisible()?n.element.style.display="none":(n.element.style.display="block",n.element.contains(i.element)||n.element.appendChild(i.element))}function u(){n.element.remove(),r.element.remove(),removeEventListener("keydown",o),removeEventListener("message",s)}function c(){document.body.appendChild(n.element),document.body.appendChild(r.element),addEventListener("keydown",o),addEventListener("message",s),kt={dispose:u}}return c()}function vu(t){return`${bn||zr?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${t}`}function Su(t){const e=document.createElement("iframe");return e.src=t,e.className="instant-devtool-iframe",Object.assign(e.style,{width:"100%",height:"100%",backgroundColor:"white",border:"none"}),{element:e}}function Ou(t,e){const n=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,r=document.createElement("button");return r.innerHTML=n,r.className="instant-devtool-toggler",Object.assign(r.style,Object.assign(Object.assign({position:"fixed"},Eu(t.position)),{height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9010",padding:"0",margin:"0",border:"none",cursor:"pointer"})),r.addEventListener("click",e),{element:r}}function Eu(t){switch(t){case"bottom-left":return{bottom:"24px",left:"24px"};case"bottom-right":return{bottom:"24px",right:"24px"};case"top-right":return{top:"24px",right:"24px"};case"top-left":return{top:"24px",left:"24px"}}}function Au(t){switch(t){case"bottom-left":return{bottom:"24px",right:"24px",left:"60px",top:"72px"};case"bottom-right":return{bottom:"24px",left:"24px",right:"60px",top:"72px"};case"top-right":return{top:"24px",left:"24px",right:"60px",bottom:"72px"};case"top-left":return{top:"24px",right:"24px",left:"60px",bottom:"72px"}}}function ku(t){const e=document.createElement("div");Object.assign(e.style,Object.assign(Object.assign({position:"fixed"},Au(t.position)),{display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"})),e.style.display="none",e.className="instant-devtool-container";function n(){return e.style.display!=="none"}return{element:e,isVisible:n}}const ju={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"};function Cu(){var t;return globalThis.__instantDbSchemaHashStore=(t=globalThis.__instantDbSchemaHashStore)!==null&&t!==void 0?t:new WeakMap,globalThis.__instantDbSchemaHashStore}function Pu(){var t;return globalThis.__instantDbStore=(t=globalThis.__instantDbStore)!==null&&t!==void 0?t:{},globalThis.__instantDbStore}function mn(t){const e=t.__adminToken;return t.appId+"_"+(t.websocketURI||"default_ws_uri")+"_"+(t.apiURI||"default_api_uri")+"_"+(e||"client_only")+"_"+t.useDateObjects}const vn=Pu(),pi=Cu();class Iu{constructor(e){this.db=e,this.sendMagicCode=n=>this.db.sendMagicCode(n),this.signInWithMagicCode=n=>this.db.signInWithMagicCode(n),this.signInWithToken=n=>this.db.signInWithCustomToken(n),this.signInAsGuest=()=>this.db.signInAsGuest(),this.createAuthorizationURL=n=>this.db.createAuthorizationURL(n),this.signInWithIdToken=n=>this.db.signInWithIdToken(n),this.exchangeOAuthCode=n=>this.db.exchangeCodeForToken(n),this.issuerURI=()=>this.db.issuerURI(),this.signOut=(n={invalidateToken:!0})=>this.db.signOut(n)}}class Mu{constructor(e){this.db=e,this.uploadFile=(n,r,i={})=>this.db.uploadFile(n,r,i),this.delete=n=>this.db.deleteFile(n),this.upload=(n,r)=>this.db.upload(n,r),this.put=this.upload,this.getDownloadUrl=n=>this.db.getDownloadUrl(n)}}function Ru(t){return JSON.parse(JSON.stringify(t))}class xu{constructor(e){this.tx=dn(),this._reactor=e,this.auth=new Iu(this._reactor),this.storage=new Mu(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,n,r){return this._reactor.subscribeQuery(e,n,r)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}getAuth(){return this._reactor.getAuth()}subscribeConnectionStatus(e){return this._reactor.subscribeConnectionStatus(e)}joinRoom(e="_defaultRoomType",n="_defaultRoomId",r){return{leaveRoom:this._reactor.joinRoom(n,r==null?void 0:r.initialPresence),subscribeTopic:(s,o)=>this._reactor.subscribeTopic(n,s,o),subscribePresence:(s,o)=>this._reactor.subscribePresence(e,n,s,o),publishTopic:(s,o)=>this._reactor.publishTopic({roomType:e,roomId:n,topic:s,data:o}),publishPresence:s=>this._reactor.publishPresence(e,n,s),getPresence:s=>this._reactor.getPresence(e,n,s)}}shutdown(){delete vn[mn(this._reactor.config)],this._reactor.shutdown()}queryOnce(e,n){return this._reactor.queryOnce(e,n)}_syncTableExperimental(e,n){return this._reactor.subscribeTable(e,n)}}function yi(t){if(!t)return"0";const e=pi.get(t);if(e)return e;const n=V(t);return pi.set(t,n),n}function Du(t,e){return yi(t._reactor.config.schema)!==yi(e)}function $u(t,e,n,r,i){var s;const o=Object.assign(Object.assign({},t),{useDateObjects:(s=t.useDateObjects)!==null&&s!==void 0?s:!1}),a=vn[mn(o)];if(a)return Du(a,o.schema)&&a._reactor.updateSchema(o.schema),a;const u=new du(Object.assign(Object.assign(Object.assign({},ju),o),{cardinalityInference:!!o.schema}),e||Fr,n||Nr,Object.assign(Object.assign({},r||{}),{"@instantdb/core":_n}),i),c=new xu(u);return vn[mn(o)]=c,Uu(o.appId,o.devtool),c}function Uu(t,e){if(typeof window>"u"||typeof window.location>"u"||typeof document>"u"||typeof e=="boolean"&&!e)return;const n=Object.assign({position:"bottom-right",allowedHosts:["localhost"]},typeof e=="object"?e:{});n.allowedHosts.includes(window.location.hostname)&&mu(t,n)}var Sn={exports:{}},nt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var bi;function Lu(){if(bi)return nt;bi=1;var t=C,e=Symbol.for("react.element"),n=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,i=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,s={key:!0,ref:!0,__self:!0,__source:!0};function o(a,u,c){var d,f={},l=null,p=null;c!==void 0&&(l=""+c),u.key!==void 0&&(l=""+u.key),u.ref!==void 0&&(p=u.ref);for(d in u)r.call(u,d)&&!s.hasOwnProperty(d)&&(f[d]=u[d]);if(a&&a.defaultProps)for(d in u=a.defaultProps,u)f[d]===void 0&&(f[d]=u[d]);return{$$typeof:e,type:a,key:l,ref:p,props:f,_owner:i.current}}return nt.Fragment=n,nt.jsx=o,nt.jsxs=o,nt}var rt={},_i;function Fu(){if(_i)return rt;_i=1;var t={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */return t.NODE_ENV!=="production"&&function(){var e=C,n=Symbol.for("react.element"),r=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),s=Symbol.for("react.strict_mode"),o=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),u=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),f=Symbol.for("react.suspense_list"),l=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),y=Symbol.for("react.offscreen"),b=Symbol.iterator,_="@@iterator";function w(h){if(h===null||typeof h!="object")return null;var T=b&&h[b]||h[_];return typeof T=="function"?T:null}var g=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function m(h){{for(var T=arguments.length,v=new Array(T>1?T-1:0),O=1;O<T;O++)v[O-1]=arguments[O];E("error",h,v)}}function E(h,T,v){{var O=g.ReactDebugCurrentFrame,I=O.getStackAddendum();I!==""&&(T+="%s",v=v.concat([I]));var R=v.map(function(P){return String(P)});R.unshift("Warning: "+T),Function.prototype.apply.call(console[h],console,R)}}var S=!1,M=!1,U=!1,Y=!1,ut=!1,Mt;Mt=Symbol.for("react.module.reference");function Dn(h){return!!(typeof h=="string"||typeof h=="function"||h===i||h===o||ut||h===s||h===d||h===f||Y||h===y||S||M||U||typeof h=="object"&&h!==null&&(h.$$typeof===p||h.$$typeof===l||h.$$typeof===a||h.$$typeof===u||h.$$typeof===c||h.$$typeof===Mt||h.getModuleId!==void 0))}function $n(h,T,v){var O=h.displayName;if(O)return O;var I=T.displayName||T.name||"";return I!==""?v+"("+I+")":v}function Rt(h){return h.displayName||"Context"}function he(h){if(h==null)return null;if(typeof h.tag=="number"&&m("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof h=="function")return h.displayName||h.name||null;if(typeof h=="string")return h;switch(h){case i:return"Fragment";case r:return"Portal";case o:return"Profiler";case s:return"StrictMode";case d:return"Suspense";case f:return"SuspenseList"}if(typeof h=="object")switch(h.$$typeof){case u:var T=h;return Rt(T)+".Consumer";case a:var v=h;return Rt(v._context)+".Provider";case c:return $n(h,h.render,"ForwardRef");case l:var O=h.displayName||null;return O!==null?O:he(h.type)||"Memo";case p:{var I=h,R=I._payload,P=I._init;try{return he(P(R))}catch{return null}}}return null}var ke=Object.assign,ct=0,ki,ji,Ci,Pi,Ii,Mi,Ri;function xi(){}xi.__reactDisabledLog=!0;function uc(){{if(ct===0){ki=console.log,ji=console.info,Ci=console.warn,Pi=console.error,Ii=console.group,Mi=console.groupCollapsed,Ri=console.groupEnd;var h={configurable:!0,enumerable:!0,value:xi,writable:!0};Object.defineProperties(console,{info:h,log:h,warn:h,error:h,group:h,groupCollapsed:h,groupEnd:h})}ct++}}function cc(){{if(ct--,ct===0){var h={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:ke({},h,{value:ki}),info:ke({},h,{value:ji}),warn:ke({},h,{value:Ci}),error:ke({},h,{value:Pi}),group:ke({},h,{value:Ii}),groupCollapsed:ke({},h,{value:Mi}),groupEnd:ke({},h,{value:Ri})})}ct<0&&m("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var Un=g.ReactCurrentDispatcher,Ln;function xt(h,T,v){{if(Ln===void 0)try{throw Error()}catch(I){var O=I.stack.trim().match(/\n( *(at )?)/);Ln=O&&O[1]||""}return`
`+Ln+h}}var Fn=!1,Dt;{var dc=typeof WeakMap=="function"?WeakMap:Map;Dt=new dc}function Di(h,T){if(!h||Fn)return"";{var v=Dt.get(h);if(v!==void 0)return v}var O;Fn=!0;var I=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var R;R=Un.current,Un.current=null,uc();try{if(T){var P=function(){throw Error()};if(Object.defineProperty(P.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(P,[])}catch(ne){O=ne}Reflect.construct(h,[],P)}else{try{P.call()}catch(ne){O=ne}h.call(P.prototype)}}else{try{throw Error()}catch(ne){O=ne}h()}}catch(ne){if(ne&&O&&typeof ne.stack=="string"){for(var j=ne.stack.split(`
`),J=O.stack.split(`
`),F=j.length-1,K=J.length-1;F>=1&&K>=0&&j[F]!==J[K];)K--;for(;F>=1&&K>=0;F--,K--)if(j[F]!==J[K]){if(F!==1||K!==1)do if(F--,K--,K<0||j[F]!==J[K]){var oe=`
`+j[F].replace(" at new "," at ");return h.displayName&&oe.includes("<anonymous>")&&(oe=oe.replace("<anonymous>",h.displayName)),typeof h=="function"&&Dt.set(h,oe),oe}while(F>=1&&K>=0);break}}}finally{Fn=!1,Un.current=R,cc(),Error.prepareStackTrace=I}var ze=h?h.displayName||h.name:"",je=ze?xt(ze):"";return typeof h=="function"&&Dt.set(h,je),je}function fc(h,T,v){return Di(h,!1)}function lc(h){var T=h.prototype;return!!(T&&T.isReactComponent)}function $t(h,T,v){if(h==null)return"";if(typeof h=="function")return Di(h,lc(h));if(typeof h=="string")return xt(h);switch(h){case d:return xt("Suspense");case f:return xt("SuspenseList")}if(typeof h=="object")switch(h.$$typeof){case c:return fc(h.render);case l:return $t(h.type,T,v);case p:{var O=h,I=O._payload,R=O._init;try{return $t(R(I),T,v)}catch{}}}return""}var dt=Object.prototype.hasOwnProperty,$i={},Ui=g.ReactDebugCurrentFrame;function Ut(h){if(h){var T=h._owner,v=$t(h.type,h._source,T?T.type:null);Ui.setExtraStackFrame(v)}else Ui.setExtraStackFrame(null)}function hc(h,T,v,O,I){{var R=Function.call.bind(dt);for(var P in h)if(R(h,P)){var j=void 0;try{if(typeof h[P]!="function"){var J=Error((O||"React class")+": "+v+" type `"+P+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof h[P]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw J.name="Invariant Violation",J}j=h[P](T,P,O,v,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(F){j=F}j&&!(j instanceof Error)&&(Ut(I),m("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",O||"React class",v,P,typeof j),Ut(null)),j instanceof Error&&!(j.message in $i)&&($i[j.message]=!0,Ut(I),m("Failed %s type: %s",v,j.message),Ut(null))}}}var pc=Array.isArray;function Nn(h){return pc(h)}function yc(h){{var T=typeof Symbol=="function"&&Symbol.toStringTag,v=T&&h[Symbol.toStringTag]||h.constructor.name||"Object";return v}}function bc(h){try{return Li(h),!1}catch{return!0}}function Li(h){return""+h}function Fi(h){if(bc(h))return m("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",yc(h)),Li(h)}var Ni=g.ReactCurrentOwner,_c={key:!0,ref:!0,__self:!0,__source:!0},Ki,Wi;function gc(h){if(dt.call(h,"ref")){var T=Object.getOwnPropertyDescriptor(h,"ref").get;if(T&&T.isReactWarning)return!1}return h.ref!==void 0}function Tc(h){if(dt.call(h,"key")){var T=Object.getOwnPropertyDescriptor(h,"key").get;if(T&&T.isReactWarning)return!1}return h.key!==void 0}function wc(h,T){typeof h.ref=="string"&&Ni.current}function mc(h,T){{var v=function(){Ki||(Ki=!0,m("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",T))};v.isReactWarning=!0,Object.defineProperty(h,"key",{get:v,configurable:!0})}}function vc(h,T){{var v=function(){Wi||(Wi=!0,m("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",T))};v.isReactWarning=!0,Object.defineProperty(h,"ref",{get:v,configurable:!0})}}var Sc=function(h,T,v,O,I,R,P){var j={$$typeof:n,type:h,key:T,ref:v,props:P,_owner:R};return j._store={},Object.defineProperty(j._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(j,"_self",{configurable:!1,enumerable:!1,writable:!1,value:O}),Object.defineProperty(j,"_source",{configurable:!1,enumerable:!1,writable:!1,value:I}),Object.freeze&&(Object.freeze(j.props),Object.freeze(j)),j};function Oc(h,T,v,O,I){{var R,P={},j=null,J=null;v!==void 0&&(Fi(v),j=""+v),Tc(T)&&(Fi(T.key),j=""+T.key),gc(T)&&(J=T.ref,wc(T,I));for(R in T)dt.call(T,R)&&!_c.hasOwnProperty(R)&&(P[R]=T[R]);if(h&&h.defaultProps){var F=h.defaultProps;for(R in F)P[R]===void 0&&(P[R]=F[R])}if(j||J){var K=typeof h=="function"?h.displayName||h.name||"Unknown":h;j&&mc(P,K),J&&vc(P,K)}return Sc(h,j,J,I,O,Ni.current,P)}}var Kn=g.ReactCurrentOwner,zi=g.ReactDebugCurrentFrame;function We(h){if(h){var T=h._owner,v=$t(h.type,h._source,T?T.type:null);zi.setExtraStackFrame(v)}else zi.setExtraStackFrame(null)}var Wn;Wn=!1;function zn(h){return typeof h=="object"&&h!==null&&h.$$typeof===n}function Vi(){{if(Kn.current){var h=he(Kn.current.type);if(h)return`

Check the render method of \``+h+"`."}return""}}function Ec(h){return""}var qi={};function Ac(h){{var T=Vi();if(!T){var v=typeof h=="string"?h:h.displayName||h.name;v&&(T=`

Check the top-level render call using <`+v+">.")}return T}}function Bi(h,T){{if(!h._store||h._store.validated||h.key!=null)return;h._store.validated=!0;var v=Ac(T);if(qi[v])return;qi[v]=!0;var O="";h&&h._owner&&h._owner!==Kn.current&&(O=" It was passed a child from "+he(h._owner.type)+"."),We(h),m('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',v,O),We(null)}}function Gi(h,T){{if(typeof h!="object")return;if(Nn(h))for(var v=0;v<h.length;v++){var O=h[v];zn(O)&&Bi(O,T)}else if(zn(h))h._store&&(h._store.validated=!0);else if(h){var I=w(h);if(typeof I=="function"&&I!==h.entries)for(var R=I.call(h),P;!(P=R.next()).done;)zn(P.value)&&Bi(P.value,T)}}}function kc(h){{var T=h.type;if(T==null||typeof T=="string")return;var v;if(typeof T=="function")v=T.propTypes;else if(typeof T=="object"&&(T.$$typeof===c||T.$$typeof===l))v=T.propTypes;else return;if(v){var O=he(T);hc(v,h.props,"prop",O,h)}else if(T.PropTypes!==void 0&&!Wn){Wn=!0;var I=he(T);m("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",I||"Unknown")}typeof T.getDefaultProps=="function"&&!T.getDefaultProps.isReactClassApproved&&m("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function jc(h){{for(var T=Object.keys(h.props),v=0;v<T.length;v++){var O=T[v];if(O!=="children"&&O!=="key"){We(h),m("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",O),We(null);break}}h.ref!==null&&(We(h),m("Invalid attribute `ref` supplied to `React.Fragment`."),We(null))}}var Qi={};function Hi(h,T,v,O,I,R){{var P=Dn(h);if(!P){var j="";(h===void 0||typeof h=="object"&&h!==null&&Object.keys(h).length===0)&&(j+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var J=Ec();J?j+=J:j+=Vi();var F;h===null?F="null":Nn(h)?F="array":h!==void 0&&h.$$typeof===n?(F="<"+(he(h.type)||"Unknown")+" />",j=" Did you accidentally export a JSX literal instead of a component?"):F=typeof h,m("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",F,j)}var K=Oc(h,T,v,I,R);if(K==null)return K;if(P){var oe=T.children;if(oe!==void 0)if(O)if(Nn(oe)){for(var ze=0;ze<oe.length;ze++)Gi(oe[ze],h);Object.freeze&&Object.freeze(oe)}else m("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else Gi(oe,h)}if(dt.call(T,"key")){var je=he(h),ne=Object.keys(T).filter(function(xc){return xc!=="key"}),Vn=ne.length>0?"{key: someKey, "+ne.join(": ..., ")+": ...}":"{key: someKey}";if(!Qi[je+Vn]){var Rc=ne.length>0?"{"+ne.join(": ..., ")+": ...}":"{}";m(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,Vn,je,Rc,je),Qi[je+Vn]=!0}}return h===i?jc(K):kc(K),K}}function Cc(h,T,v){return Hi(h,T,v,!0)}function Pc(h,T,v){return Hi(h,T,v,!1)}var Ic=Pc,Mc=Cc;rt.Fragment=i,rt.jsx=Ic,rt.jsxs=Mc}(),rt}var Nu={};Nu.NODE_ENV==="production"?Sn.exports=Lu():Sn.exports=Fu();var G=Sn.exports;const Ku={isLoading:!0,data:void 0,pageInfo:void 0,error:void 0};function gi(t){return Object.assign({isLoading:!t,data:void 0,pageInfo:void 0,error:void 0},t||{})}function Wu(t,e,n){e&&n&&"ruleParams"in n&&(e=Object.assign({$$ruleParams:n.ruleParams},e));const r=e?Ru(e):null,i=V(r),s=C.useRef(gi(t._reactor.getPreviousResult(r))),o=C.useCallback(u=>(s.current=gi(t._reactor.getPreviousResult(r)),r?t.subscribeQuery(r,d=>{s.current=Object.assign({isLoading:!d,data:void 0,pageInfo:void 0,error:void 0},d),u()}):()=>{}),[i]);return{state:C.useSyncExternalStore(o,()=>s.current,()=>Ku),query:r}}function zu(){const t=C.useRef(null);C.useEffect(()=>{n()},[]);function e(r,i){n(),t.current=setTimeout(i,r)}function n(){t.current&&clearTimeout(t.current)}return{set:e,clear:n}}const Vu=1e3;function qu(t,e,n){const r=C.useRef(n);r.current=n,C.useEffect(()=>t.core._reactor.subscribeTopic(t.id,e,(s,o)=>{r.current(s,o)}),[t.id,e])}function Bu(t,e){return C.useEffect(()=>t.core._reactor.joinRoom(t.id),[t.id]),C.useCallback(r=>{t.core._reactor.publishTopic({roomType:t.type,roomId:t.id,topic:e,data:r})},[t.id,e])}function Gu(t,e={}){var n,r;const[i,s]=C.useState(()=>{var u;return(u=t.core._reactor.getPresence(t.type,t.id,e))!==null&&u!==void 0?u:{peers:{},isLoading:!0}});C.useEffect(()=>t.core._reactor.subscribePresence(t.type,t.id,e,c=>{s(c)}),[t.id,e.user,(n=e.peers)===null||n===void 0?void 0:n.join(),(r=e.keys)===null||r===void 0?void 0:r.join()]);const o=C.useCallback(u=>{t.core._reactor.publishPresence(t.type,t.id,u)},[t.type,t.id]);return C.useMemo(()=>Object.assign(Object.assign({},i),{publishPresence:o}),[i,o])}function Qu(t,e,n){C.useEffect(()=>t.core._reactor.joinRoom(t.id,e),[t.id]),C.useEffect(()=>t.core._reactor.publishPresence(t.type,t.id,e),[t.type,t.id,n??JSON.stringify(e)])}function Hu(t,e,n={}){const r=zu(),i=Ee.usePresence(t,{keys:[e]}),s=C.useMemo(()=>{var d;const f=t._core._reactor.getPresence(t.type,t.id);return n!=null&&n.writeOnly?[]:Object.values((d=f==null?void 0:f.peers)!==null&&d!==void 0?d:{}).filter(l=>l[e]===!0)},[n==null?void 0:n.writeOnly,i]),o=C.useCallback(d=>{var f;t.core._reactor.publishPresence(t.type,t.id,{[e]:d}),d&&((n==null?void 0:n.timeout)===null||(n==null?void 0:n.timeout)===0||r.set((f=n==null?void 0:n.timeout)!==null&&f!==void 0?f:Vu,()=>{t.core._reactor.publishPresence(t.type,t.id,{[e]:null})}))},[t.type,t.id,e,n==null?void 0:n.timeout,r]),a=C.useCallback(d=>{const l=!((n==null?void 0:n.stopOnEnter)&&d.key==="Enter");o(l)},[n.stopOnEnter,o]),u=C.useCallback(()=>{o(!1)},[o]),c=C.useMemo(()=>({onKeyDown:a,onBlur:u}),[a,u]);return{active:s,setActive:o,inputProps:c}}const Ee={useTopicEffect:qu,usePublishTopic:Bu,usePresence:Gu,useSyncPresence:Qu,useTypingIndicator:Hu};class Yu{constructor(e,n,r){this.useTopicEffect=(i,s)=>{Ee.useTopicEffect(this,i,s)},this.usePublishTopic=i=>Ee.usePublishTopic(this,i),this.usePresence=(i={})=>Ee.usePresence(this,i),this.useSyncPresence=(i,s)=>Ee.useSyncPresence(this,i,s),this.useTypingIndicator=(i,s={})=>Ee.useTypingIndicator(this,i,s),this.core=e,this._core=this.core,this.type=n,this.id=r}}var Ju=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(d){try{c(r.next(d))}catch(f){o(f)}}function u(d){try{c(r.throw(d))}catch(f){o(f)}}function c(d){d.done?s(d.value):i(d.value).then(a,u)}c((r=r.apply(t,e||[])).next())})};const Zu={isLoading:!0,user:void 0,error:void 0};class Ti{constructor(e,n){this.tx=dn(),this.getLocalId=r=>this.core.getLocalId(r),this.useLocalId=r=>{const[i,s]=C.useState(null);return C.useEffect(()=>{Ju(this,void 0,void 0,function*(){const a=yield this.getLocalId(r);s(a)})},[r]),i},this.rooms=Ee,this.transact=r=>this.core.transact(r),this.useQuery=(r,i)=>Wu(this.core,r,i).state,this.useAuth=()=>{const r=C.useRef(this.core._reactor._currentUserCached),i=C.useCallback(o=>this.core.subscribeAuth(u=>{r.current=Object.assign({isLoading:!1},u),o()}),[]);return C.useSyncExternalStore(i,()=>r.current,()=>Zu)},this.useUser=()=>{const{user:r}=this.useAuth();if(!r)throw new xe("useUser must be used within an auth-protected route");return r},this.useConnectionStatus=()=>{const r=C.useRef(this.core._reactor.status),i=C.useCallback(o=>this.core.subscribeConnectionStatus(u=>{u!==r.current&&(r.current=u,o())}),[]);return C.useSyncExternalStore(i,()=>r.current,()=>"connecting")},this.queryOnce=(r,i)=>this.core.queryOnce(r,i),this.SignedIn=({children:r})=>{const i=this.useAuth();return i.isLoading||i.error||!i.user?null:G.jsx(G.Fragment,{children:r})},this.SignedOut=({children:r})=>{const i=this.useAuth();return i.isLoading||i.error||i.user?null:G.jsx(G.Fragment,{children:r})},this.core=$u(e,this.constructor.Storage,this.constructor.NetworkListener,n,this.constructor.EventSourceImpl),this._core=this.core,this.auth=this.core.auth,this.storage=this.core.storage}room(e="_defaultRoomType",n="_defaultRoomId"){return new Yu(this.core,e,n)}getAuth(){return this.core.getAuth()}}class wi extends Error{constructor(e,n){super(e),this.name="ParseError",this.type=n.type,this.field=n.field,this.value=n.value,this.line=n.line}}function On(t){}function Xu(t){if(typeof t=="function")throw new TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");const{onEvent:e=On,onError:n=On,onRetry:r=On,onComment:i}=t;let s="",o=!0,a,u="",c="";function d(b){const _=o?b.replace(/^\xEF\xBB\xBF/,""):b,[w,g]=ec(`${s}${_}`);for(const m of w)f(m);s=g,o=!1}function f(b){if(b===""){p();return}if(b.startsWith(":")){i&&i(b.slice(b.startsWith(": ")?2:1));return}const _=b.indexOf(":");if(_!==-1){const w=b.slice(0,_),g=b[_+1]===" "?2:1,m=b.slice(_+g);l(w,m,b);return}l(b,"",b)}function l(b,_,w){switch(b){case"event":c=_;break;case"data":u=`${u}${_}
`;break;case"id":a=_.includes("\0")?void 0:_;break;case"retry":/^\d+$/.test(_)?r(parseInt(_,10)):n(new wi(`Invalid \`retry\` value: "${_}"`,{type:"invalid-retry",value:_,line:w}));break;default:n(new wi(`Unknown field "${b.length>20?`${b.slice(0,20)}`:b}"`,{type:"unknown-field",field:b,value:_,line:w}));break}}function p(){u.length>0&&e({id:a,event:c||void 0,data:u.endsWith(`
`)?u.slice(0,-1):u}),a=void 0,u="",c=""}function y(b={}){s&&b.consume&&f(s),o=!0,a=void 0,u="",c="",s=""}return{feed:d,reset:y}}function ec(t){const e=[];let n="",r=0;for(;r<t.length;){const i=t.indexOf("\r",r),s=t.indexOf(`
`,r);let o=-1;if(i!==-1&&s!==-1?o=Math.min(i,s):i!==-1?o=i:s!==-1&&(o=s),o===-1){n=t.slice(r);break}else{const a=t.slice(r,o);e.push(a),r=o+1,t[r-1]==="\r"&&t[r]===`
`&&r++}}return[e,n]}class mi extends Event{constructor(e,n){var r,i;super(e),this.code=(r=n==null?void 0:n.code)!=null?r:void 0,this.message=(i=n==null?void 0:n.message)!=null?i:void 0}[Symbol.for("nodejs.util.inspect.custom")](e,n,r){return r(vi(this),n)}[Symbol.for("Deno.customInspect")](e,n){return e(vi(this),n)}}function tc(t){const e=globalThis.DOMException;return typeof e=="function"?new e(t,"SyntaxError"):new SyntaxError(t)}function En(t){return t instanceof Error?"errors"in t&&Array.isArray(t.errors)?t.errors.map(En).join(", "):"cause"in t&&t.cause instanceof Error?`${t}: ${En(t.cause)}`:t.message:`${t}`}function vi(t){return{type:t.type,message:t.message,code:t.code,defaultPrevented:t.defaultPrevented,cancelable:t.cancelable,timeStamp:t.timeStamp}}var Si=t=>{throw TypeError(t)},An=(t,e,n)=>e.has(t)||Si("Cannot "+n),A=(t,e,n)=>(An(t,e,"read from private field"),n?n.call(t):e.get(t)),z=(t,e,n)=>e.has(t)?Si("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),$=(t,e,n,r)=>(An(t,e,"write to private field"),e.set(t,n),n),ge=(t,e,n)=>(An(t,e,"access private method"),n),te,Ae,Ue,jt,Ct,it,Le,st,we,Fe,Ne,Ke,ot,de,kn,jn,Cn,Oi,Pn,In,at,Mn,Rn;class Pt extends EventTarget{constructor(e,n){var r,i;super(),z(this,de),this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,z(this,te),z(this,Ae),z(this,Ue),z(this,jt),z(this,Ct),z(this,it),z(this,Le),z(this,st,null),z(this,we),z(this,Fe),z(this,Ne,null),z(this,Ke,null),z(this,ot,null),z(this,jn,async s=>{var o;A(this,Fe).reset();const{body:a,redirected:u,status:c,headers:d}=s;if(c===204){ge(this,de,at).call(this,"Server sent HTTP 204, not reconnecting",204),this.close();return}if(u?$(this,Ue,new URL(s.url)):$(this,Ue,void 0),c!==200){ge(this,de,at).call(this,`Non-200 status code (${c})`,c);return}if(!(d.get("content-type")||"").startsWith("text/event-stream")){ge(this,de,at).call(this,'Invalid content type, expected "text/event-stream"',c);return}if(A(this,te)===this.CLOSED)return;$(this,te,this.OPEN);const f=new Event("open");if((o=A(this,ot))==null||o.call(this,f),this.dispatchEvent(f),typeof a!="object"||!a||!("getReader"in a)){ge(this,de,at).call(this,"Invalid response body, expected a web ReadableStream",c),this.close();return}const l=new TextDecoder,p=a.getReader();let y=!0;do{const{done:b,value:_}=await p.read();_&&A(this,Fe).feed(l.decode(_,{stream:!b})),b&&(y=!1,A(this,Fe).reset(),ge(this,de,Mn).call(this))}while(y)}),z(this,Cn,s=>{$(this,we,void 0),!(s.name==="AbortError"||s.type==="aborted")&&ge(this,de,Mn).call(this,En(s))}),z(this,Pn,s=>{typeof s.id=="string"&&$(this,st,s.id);const o=new MessageEvent(s.event||"message",{data:s.data,origin:A(this,Ue)?A(this,Ue).origin:A(this,Ae).origin,lastEventId:s.id||""});A(this,Ke)&&(!s.event||s.event==="message")&&A(this,Ke).call(this,o),this.dispatchEvent(o)}),z(this,In,s=>{$(this,it,s)}),z(this,Rn,()=>{$(this,Le,void 0),A(this,te)===this.CONNECTING&&ge(this,de,kn).call(this)});try{if(e instanceof URL)$(this,Ae,e);else if(typeof e=="string")$(this,Ae,new URL(e,nc()));else throw new Error("Invalid URL")}catch{throw tc("An invalid or illegal string was specified")}$(this,Fe,Xu({onEvent:A(this,Pn),onRetry:A(this,In)})),$(this,te,this.CONNECTING),$(this,it,3e3),$(this,Ct,(r=n==null?void 0:n.fetch)!=null?r:globalThis.fetch),$(this,jt,(i=n==null?void 0:n.withCredentials)!=null?i:!1),ge(this,de,kn).call(this)}get readyState(){return A(this,te)}get url(){return A(this,Ae).href}get withCredentials(){return A(this,jt)}get onerror(){return A(this,Ne)}set onerror(e){$(this,Ne,e)}get onmessage(){return A(this,Ke)}set onmessage(e){$(this,Ke,e)}get onopen(){return A(this,ot)}set onopen(e){$(this,ot,e)}addEventListener(e,n,r){const i=n;super.addEventListener(e,i,r)}removeEventListener(e,n,r){const i=n;super.removeEventListener(e,i,r)}close(){A(this,Le)&&clearTimeout(A(this,Le)),A(this,te)!==this.CLOSED&&(A(this,we)&&A(this,we).abort(),$(this,te,this.CLOSED),$(this,we,void 0))}}te=new WeakMap,Ae=new WeakMap,Ue=new WeakMap,jt=new WeakMap,Ct=new WeakMap,it=new WeakMap,Le=new WeakMap,st=new WeakMap,we=new WeakMap,Fe=new WeakMap,Ne=new WeakMap,Ke=new WeakMap,ot=new WeakMap,de=new WeakSet,kn=function(){$(this,te,this.CONNECTING),$(this,we,new AbortController),A(this,Ct)(A(this,Ae),ge(this,de,Oi).call(this)).then(A(this,jn)).catch(A(this,Cn))},jn=new WeakMap,Cn=new WeakMap,Oi=function(){var t;const e={mode:"cors",redirect:"follow",headers:{Accept:"text/event-stream",...A(this,st)?{"Last-Event-ID":A(this,st)}:void 0},cache:"no-store",signal:(t=A(this,we))==null?void 0:t.signal};return"window"in globalThis&&(e.credentials=this.withCredentials?"include":"same-origin"),e},Pn=new WeakMap,In=new WeakMap,at=function(t,e){var n;A(this,te)!==this.CLOSED&&$(this,te,this.CLOSED);const r=new mi("error",{code:e,message:t});(n=A(this,Ne))==null||n.call(this,r),this.dispatchEvent(r)},Mn=function(t,e){var n;if(A(this,te)===this.CLOSED)return;$(this,te,this.CONNECTING);const r=new mi("error",{code:e,message:t});(n=A(this,Ne))==null||n.call(this,r),this.dispatchEvent(r),$(this,Le,setTimeout(A(this,Rn),A(this,it)))},Rn=new WeakMap,Pt.CONNECTING=0,Pt.OPEN=1,Pt.CLOSED=2;function nc(){const t="document"in globalThis?globalThis.document:void 0;return t&&typeof t=="object"&&"baseURI"in t&&typeof t.baseURI=="string"?t.baseURI:void 0}const xn=class xn extends Ti{};xn.EventSourceImpl=Pt;let It=xn;function Ei(t){const e={...t,useDateObjects:t.useDateObjects??!1};return new It(e,{"@instantdb/react":_n})}const rc=Ei;function ic({as:t="div",spaceId:e,room:n,className:r,style:i,userCursorColor:s,children:o,renderCursor:a,propagate:u,zIndex:c}){const d=e||`cursors-space-default--${String(n.type)}-${n.id}`,f=n.usePresence({keys:[d]}),l=n._core._reactor.getPresence(n.type,n.id);function p(g,m){const E=m.clientX,S=m.clientY,M=(E-g.left)/g.width*100,U=(S-g.top)/g.height*100;f.publishPresence({[d]:{x:E,y:S,xPercent:M,yPercent:U,color:s}})}function y(g){u||g.stopPropagation();const m=g.currentTarget.getBoundingClientRect();p(m,g)}function b(g){f.publishPresence({[d]:void 0})}function _(g){if(g.touches.length!==1)return;const m=g.touches[0];if(m.target instanceof Element){u||g.stopPropagation();const E=m.target.getBoundingClientRect();p(E,m)}}function w(g){f.publishPresence({[d]:void 0})}return C.createElement(t,{onMouseMove:y,onMouseOut:b,onTouchMove:_,onTouchEnd:w,className:r,style:{position:"relative",...i}},[o,G.jsx("div",{style:{...Ai,...oc,zIndex:c!==void 0?c:ac},children:Object.entries(f.peers).map(([g,m])=>{const E=m[d];return E?G.jsx("div",{style:{...Ai,transform:`translate(${E.xPercent}%, ${E.yPercent}%)`,transformOrigin:"0 0",transition:"transform 100ms"},children:a?a({color:E.color,presence:l==null?void 0:l.peers[g]}):G.jsx(sc,{...E})},g):null})},d)])}function sc({color:t}){const n=t||"black";return G.jsxs("svg",{style:{height:35,width:35},viewBox:"0 0 35 35",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[G.jsxs("g",{fill:"rgba(0,0,0,.2)",transform:"matrix(1, 0, 0, 1, -11.999999046325684, -8.406899452209473)",children:[G.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),G.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),G.jsxs("g",{fill:"white",transform:"matrix(1, 0, 0, 1, -11.999999046325684, -8.406899452209473)",children:[G.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),G.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),G.jsxs("g",{fill:n,transform:"matrix(1, 0, 0, 1, -11.999999046325684, -8.406899452209473)",children:[G.jsx("path",{d:"m19.751 24.4155-1.844.774-3.1-7.374 1.841-.775z"}),G.jsx("path",{d:"m13 10.814v11.188l2.969-2.866.428-.139h4.768z"})]})]})}const Ai={position:"absolute",top:0,left:0,bottom:0,right:0},oc={overflow:"hidden",pointerEvents:"none",userSelect:"none"},ac=99999;D.Cursors=ic,D.InstantAPIError=Xe,D.InstantReactAbstractDatabase=Ti,D.InstantReactWebDatabase=It,D.i=wu,D.id=W,D.init=Ei,D.init_experimental=rc,D.lookup=Uo,D.tx=Fo,Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});
